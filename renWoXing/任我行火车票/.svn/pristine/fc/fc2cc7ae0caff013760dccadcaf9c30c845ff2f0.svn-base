//
//  DZXZVc.m
//  CommonProject
//
//  Created by gaoguangxiao on 2017/1/7.
//  Copyright © 2017年 mac. All rights reserved.
//

#import "DZXZVc.h"
#import "LDCalendarView.h"
#import "NSDate+extend.h"
#import "SearchResVc.h"
#import "ChooseDateViewController.h"
#import "ChooseSeatTypeVc.h"
#import "PayView.h"
#import "SubmitOrderVc.h"

@interface DZXZVc ()
{
    TrainStation *chufadiSt;
    TrainStation *mudidiSt;

    NSMutableArray <Customer *>*selectedCustomer;
    NSMutableArray <DateObject *>*selectedDate;
    NSMutableArray <SeatType *>*selectedType;

    NSMutableArray *selectedCheci;

    NSString *train_date;
    UIView *qpxinxi ;//抢票信息模块
    UIView *psxinxi;//配送信息模块
    PayView *payView ;
}
@property (nonatomic,assign)BOOL issingle;//是否是单选



@end

@implementation DZXZVc

- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.navBar.hidden = NO;
    selectedCustomer = [NSMutableArray array];
    selectedDate = [NSMutableArray array];
    selectedCheci = [NSMutableArray array];
    selectedType = [NSMutableArray array];
    
    
    
    
    
    if (self.from == 1 || self.from==2 || self.from==3) {
        self.title = self.preObjvalue;
        self.issingle = YES;
    }
    if (self.from==4) {
        self.title = @"添加12306抢票任务";
    }else if (self.from == 5){
        self.title = @"添加人工抢票任务";
        self.issingle = YES;
        
    }
  
    
    //初始化公用视图和数据
    [self initCommonData];
    
    
    //初始化上个界面所选择的车次信息
    //说明是从查询某一趟车的结果页面过来的，进入添加抢票页面时，需要把所选的车次信息填入
    if ([self.preObjvalue isKindOfClass:[CheCiRes class]]) {
        CheCiRes *result = self.preObjvalue;
        
        [self.stationArr enumerateObjectsUsingBlock:^(TrainStation * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            if ([obj.szm isEqualToString:result.from_station_code]) {
                chufadiSt = obj;
            } 
            if ([obj.szm isEqualToString:result.to_station_code]) {
                mudidiSt = obj;
            } 
        }];
        [self setStaionTtile];
        DateObject *date = [[DateObject alloc]init];
#warning        此处日期显示需要更改
        if (result.train_start_date.length==8) {
            NSMutableString *s = [NSMutableString stringWithString:result.train_start_date];
            [s insertString:@"-" atIndex:4];
            [s insertString:@"-" atIndex:7];
            result.train_start_date = s;
            
        }
        date.showStr = result.train_start_date;
        date.originalStr = result.train_start_date;
        [selectedDate addObject:date];
        [selectedCheci addObject:result];
        
        [self showDate];
        [self showCheci];
    }
    
    
    
    
    
    
    if (self.from==4) {
        [self init12306QP];
    }else if (self.from ==  5){
        [self initRGQP];
    }
    [self updateChengkeView];
    
}
-(void)initCommonData{
    self.automaticallyAdjustsScrollViewInsets = NO;
    [self initStation];
    
    [self.stationArr enumerateObjectsUsingBlock:^(TrainStation * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
        if ([obj.name isEqualToString:@"北京"]) {
            chufadiSt = obj;
        } 
        if ([obj.name isEqualToString:@"上海"]) {
            mudidiSt = obj;
        } 
    }];
    self.xiayibu.superview.backgroundColor = [UIColor clearColor];
    [self.xiayibu addTarget:self action:@selector(nextStep:) forControlEvents:UIControlEventTouchUpInside];
    
    [self setStaionTtile];
    self.chengkeView.height = 0;
    [self updateChengkeView];
    if (self.from==4 || self.from == 5) {
        
        [self initPayView];
    }
    

}
#pragma mark - 12306抢票
-(void)init12306QP{
    self.xiayibu.hidden = YES;
    
    qpxinxi = [[NSBundle mainBundle] loadNibNamed:@"qiangpiaoxinxi" owner:self options:nil].firstObject;
    qpxinxi.frame = CGRectMake(0, self.chengkeView.bottom, SWIDTH, 170);
    [self.xiayibu.superview addSubview:qpxinxi];
    
    
}
#pragma mark - 人工抢票
-(void)initRGQP{
    self.xiayibu.hidden = YES;
    
    qpxinxi = [[NSBundle mainBundle] loadNibNamed:@"qiangpiaoxinxi" owner:self options:nil].firstObject;
    qpxinxi.frame = CGRectMake(0, self.chengkeView.bottom, SWIDTH, 170);
    [self.xiayibu.superview addSubview:qpxinxi];
    
    
    psxinxi = [[NSBundle mainBundle] loadNibNamed:@"qiangpiaoxinxi" owner:self options:nil].lastObject;
    psxinxi.frame = CGRectMake(0, qpxinxi.bottom, SWIDTH, 120);
    [self.xiayibu.superview addSubview:psxinxi];
}
-(void)initPayView{
   
    payView = [[PayView alloc]initWithFrame:CGRectMake(0, SHEIGHT - 45, SWIDTH, 45)];
    payView.clipsToBounds = YES;
    [payView.moneyBtn addTarget:self action:@selector(changeHeight) forControlEvents:UIControlEventTouchUpInside];
    
    [self.view addSubview:payView];
    
    NSLog(@"");
}
-(void)changeHeight{
    [UIView animateWithDuration:0.5 animations:^{
        
    if (payView.height==45) {
        payView.height = 45*3;
        payView.top = SHEIGHT - payView.height;
    }else{
        payView.height = 45;
        payView.top = SHEIGHT - payView.height;

    }
    }];
}
-(void)updateChengkeView{
    CGFloat height = selectedCustomer.count*50;
    self.chengkeView.height = height;
    NSInteger index= 100 ;
    for (Customer *cus in selectedCustomer) {
        UIView *view = [self.chengkeView viewWithTag:index];
        UILabel *l1 = [view viewWithTag:10];
        l1.text = cus.name;
        UILabel *l2 = [view viewWithTag:11];
        l2.text = cus.type_name;
        UILabel *l3 = [view viewWithTag:12];
        l3.text = cus.id_number;

        
        
        
        index+=1;
    }
    
    CGFloat hh = self.chengkeView.bottom + 100;

    self.xiayibu.top = self.chengkeView.bottom+30;
    if (qpxinxi) {
        qpxinxi.top = self.chengkeView.bottom;
        hh = qpxinxi.bottom + 100;
    }
    if (psxinxi) {
        psxinxi.top = qpxinxi.bottom;
        hh = psxinxi.bottom + 100;

    }
    if (hh<=SHEIGHT) {
        hh=SHEIGHT+1;
    }
    self.bgScView.contentSize = CGSizeMake(SWIDTH, hh);
}
- (void)showDate {
    NSMutableString *str = [NSMutableString string];
    DateObject *oobj = selectedDate.firstObject;
    train_date = oobj.originalStr;
    
    for (DateObject *date in selectedDate) {
        
        [str appendFormat:@"%@,",date.originalStr];
    }
    [self.riqiBtn setTitle:str forState:UIControlStateNormal];
    
}
-(void)showSeattype{
    NSMutableString *str = [NSMutableString string];

    for (SeatType *type in selectedType) {
        
        [str appendFormat:@"%@,",type.name];
    }
    [self.leixing setTitle:str forState:UIControlStateNormal];
}
-(void)showCheci{
    NSMutableString *str = [NSMutableString string];
    
    for (CheCiRes *checi in selectedCheci) {
        
        [str appendFormat:@"%@ ,",checi.train_code];
    }
    [self.checiBtn setTitle:str forState:UIControlStateNormal];
}
- (IBAction)mudidi:(UIButton *)sender {
    BaseViewController *vc = (BaseViewController *)[self getVCInBoard:nil ID:@"ChoeseStationVC"];
    vc.touchEvent = ^(id value){
        TrainStation *st = value;
        mudidiSt = st;
        
        [sender setTitle:st.name forState:UIControlStateNormal];
        NSLog(@"选择了:%@",st.name);
    };
    PUSH(vc);
}
- (IBAction)chufaact:(UIButton *)sender {
    BaseViewController *vc = (BaseViewController *)[self getVCInBoard:nil ID:@"ChoeseStationVC"];
    vc.touchEvent = ^(id value){
        TrainStation *st = value;
        chufadiSt = st;
        
        [sender setTitle:st.name forState:UIControlStateNormal];
        NSLog(@"选择了:%@",st.name);
    };
    PUSH(vc);
}
-(void)setStaionTtile{
    [_chufadi setTitle:chufadiSt.name forState:UIControlStateNormal];
    [_mudidi setTitle:mudidiSt.name forState:UIControlStateNormal];
}
- (IBAction)qiehuan:(UIButton *)sender {
    TrainStation *st = chufadiSt;
    chufadiSt = mudidiSt;
    mudidiSt = st;
    [self setStaionTtile];
   
}
- (IBAction)riqi:(UIButton *)sender {
    ChooseDateViewController *vc = (ChooseDateViewController *)[self getVCInBoard:nil ID:@"ChooseDateViewController"];
    vc.preObjvalue = selectedDate; 
    vc.issingle = self.issingle;
    
    __weak typeof(self) weakSelf = self;
    vc.touchEvent = ^(id value){
        if ([value isKindOfClass:[NSArray class]]) {
            selectedDate = value;
            [weakSelf showDate];
        }  
    };

    PUSH(vc);
}
#pragma mark - 选择车次
- (IBAction)checi:(UIButton *)sender {
    if (selectedDate.count<1) {
        [LoadingView showAMessage:@"请选择乘车时间"];
        return;
    }


    SearchResVc *vc = (SearchResVc *)[self getVCInBoard:nil ID:@"SearchResVc"];
    __weak typeof(self) weakSelf = self;
    vc.isFromDZ = YES;
    if (!train_date) {
        train_date = [AppManager getCurrentTimeStrWithformat:@"yyyy-MM-dd"];
    }
    vc.preObjvalue = @[chufadiSt,mudidiSt,train_date,@1];
    vc.issingle = self.issingle;
    
    
    vc.touchEvent = ^(id value){
        if ([value isKindOfClass:[NSArray class]]) {
            selectedCheci = value;
            [weakSelf showCheci];
        }  
    };
    
    PUSH(vc);
}
- (IBAction)leixing:(UIButton *)sender {
    if (selectedDate.count<1) {
        [LoadingView showAMessage:@"请选择乘车时间"];
        return;
    }
    if (selectedCheci.count<1) {
        [LoadingView showAMessage:@"请选择车次"];
        return;
    }


    
    ChooseSeatTypeVc *vc = (ChooseSeatTypeVc *)[self getVCInBoard:nil ID:@"ChooseSeatTypeVc"];
    vc.preObjvalue = selectedType;
    vc.issingle = NO;
    NSMutableArray *allhaveTypeArr = [NSMutableArray array];
    for (CheCiRes *res  in selectedCheci) {
        for (NSString *strr in res.seatTypeArr) {
            if (![allhaveTypeArr containsObject:strr]) {
                [allhaveTypeArr addObject:strr];
            }
        }
    }
    vc.haveTypeArr = allhaveTypeArr;
    __weak typeof(self) weakSelf = self;
    vc.touchEvent = ^(id value){
        if ([value isKindOfClass:[NSArray class]]) {
            selectedType = value;
            [weakSelf showSeattype];
        }  
    };
    PUSH(vc);
}
- (IBAction)tianjiack:(UIButton *)sender {
    BOOL isLogin = [[NSUserDefaults standardUserDefaults]boolForKey:@"isrxlogin"];
    if (!isLogin) {
        
        BaseViewController *vcv = (BaseViewController *)[AppManager getVCInBoard:nil ID:@"LoginVc"];
        
        vcv.preObjvalue = @"DZXZVc";
        PUSH(vcv);
        return;
    }
    
    
    
    BaseViewController *vc = (BaseViewController *)[self getVCInBoard:nil ID:@"ChoosePerson"];
    vc.preObjvalue = selectedCustomer;
    __weak typeof(self) weakSelf = self;
    vc.touchEvent = ^(id value){
        if ([value isKindOfClass:[NSArray class]]) {
            selectedCustomer = value;
            [weakSelf updateChengkeView];
        }  
    };
    PUSH(vc);
}


- (IBAction)delete:(UIButton *)sender {
    NSInteger index = sender.superview.tag - 100;
    if (index<selectedCustomer.count) {
        [selectedCustomer removeObjectAtIndex:index];
        [self updateChengkeView];
    }
}
-(void)nextStep:(UIButton *)btn{
    //测试

    
    
    if (!chufadiSt) {
        return;
    }
    if (!mudidiSt) {
        return;
    }
    if (selectedDate.count<1) {
        [LoadingView showAMessage:@"请选择乘车时间"];
        return;
    }
    if (selectedCheci.count<1) {
        [LoadingView showAMessage:@"请选择车次"];
        return;
    }

    if (selectedType.count<1) {
        [LoadingView showAMessage:@"请选择坐席类型"];
        return;
    }
    if (selectedCustomer.count<1) {
        [LoadingView showAMessage:@"请选择乘客"];
        return;
    }
    
    if ([btn.currentTitle isEqualToString:@"下一步(选座)"]) {
       
        SubmitOrderVc *vc = (SubmitOrderVc *)[self getVCInBoard:nil ID:@"SubmitOrderVc"];
        vc.title = @"选择座位";
        
        vc.issirendingzhi = YES;
        vc.preObjvalue = @[chufadiSt,mudidiSt,train_date,selectedCheci.firstObject,selectedType.firstObject,selectedCustomer];

        PUSH(vc);
    }
    
}
@end
