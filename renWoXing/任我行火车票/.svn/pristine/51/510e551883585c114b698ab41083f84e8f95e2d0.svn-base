//
//  HomeViewController.m
//  CommonProject
//
//  Created by mac on 2016/12/20.
//  Copyright © 2016年 mac. All rights reserved.
//

#import "HomeViewController.h"
#import "NSString+Hash.h"
#import "CocoaSecurity.h"
#import "NSString+Encryption.h"
#import "RSA.h"

#import "CBAlertView.h"
#import "SearchResVc.h"
#import "SDCycleScrollView.h"
#import "AppDelegate.h"
#import <UIButton+WebCache.h>
#import "HZQDatePickerView.h"

@interface HomeViewController ()<SDCycleScrollViewDelegate>
{
    
    SDCycleScrollView *bannerScrollView;
    NSArray *bannerData;
    TrainStation *chufadiSt;
    TrainStation *mudidiSt;
    HZQDatePickerView *_pikerView;
    NSDictionary *peizhiPar;
    NSArray *adInfo;
    NSDictionary *baoxianInfo;
    NSDictionary *adressInfo;

    UIImageView *startImageView;
}
@end

@implementation HomeViewController
-(void)hideStart:(UIButton *)btn{
    UIView *view = startImageView.superview;
    if (view) {
        [UIView animateWithDuration:0.24 animations:^{
            view.alpha = 0.0;
            view.transform = CGAffineTransformMakeScale(1.5, 1.5);
        } completion:^(BOOL finished) {
            [view removeFromSuperview];
            
        }];
    }
}
- (void)viewDidLoad {
    [super viewDidLoad];
    self.navigationController.navigationBar.hidden = YES;
    self.navBar.hidden = YES;
    

    
    
//    [self testLogin:nil];
//     [self yupiaoSearchst1:stationArr[0] st2:stationArr[20]];
    
    
   {
        
//        AppDelegate *app = (AppDelegate *)[UIApplication sharedApplication].delegate;
//        UIView *startView = [[[NSBundle mainBundle] loadNibNamed:@"StartView" owner:nil options:nil] firstObject];
//        startView.frame = self.view.frame;
//        startImageView = [startView viewWithTag:1];
//        [app.window addSubview:startView];
//      
//       dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
//           [self hideStart:nil];
//           
//       });
        
    }

    [self.chooeseDate setTitle:[AppManager getCurrentTimeStrWithformat:@"yyyy-MM-dd"] forState:UIControlStateNormal];
    [self setupBanner];
    
    
    [self getPar];
    [self getStart];
    [self getAd];
    self.needTap = NO;
    
    [self initStation];
    [self adressInfo];
    [self.stationArr enumerateObjectsUsingBlock:^(TrainStation * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
        if ([obj.name isEqualToString:@"北京"]) {
            chufadiSt = obj;
        } 
        if ([obj.name isEqualToString:@"上海"]) {
            mudidiSt = obj;
        } 
    }];
    
    [_chufadiBtn setTitle:chufadiSt.name forState:UIControlStateNormal];
    [_mudidiBtn setTitle:mudidiSt.name forState:UIControlStateNormal];
    
 
    [self setHis];
    
}
-(void)setAdView:(NSArray *)data{
   
    NSInteger index = 0;
    CGFloat w = 45;
    CGFloat h = 60;
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(10, SHEIGHT-50-h*2-10, SWIDTH-20, h*2)];
    CGFloat space = (view.width-45*4)/3.0;
//    view.backgroundColor = [[UIColor whiteColor] colorWithAlphaComponent:0.9];
    view.backgroundColor = [UIColor clearColor];
    view.layer.cornerRadius = 1;
    view.layer.masksToBounds = YES;
    [self.view addSubview:view];
    for (int i=0; i<2; i++) {
        for (int j=0; j<4; j++) {
            if (index<data.count) {
                NSDictionary *dic = data[i];
                UIButton *btn = [[UIButton alloc]initWithFrame:CGRectMake((w+space)*j, h*i+10, w, w)];
                [btn sd_setImageWithURL:[NSURL URLWithString:dic[@"adimg"]] forState:UIControlStateNormal];
//                [btn setImage:[UIImage imageNamed:@"Icon"] forState:UIControlStateNormal];
            btn.backgroundColor = [UIColor whiteColor];
            
                btn.layer.cornerRadius = btn.height*0.5;
                btn.layer.masksToBounds = YES;
                [btn addTarget:self action:@selector(adAct:) forControlEvents:UIControlEventTouchUpInside];
                
//                [btn setTitle:@"adimg" forState:UIControlStateNormal];
                btn.tag = index+1;
                [view addSubview:btn];
//                
//                UILabel *lable = [[UILabel alloc]initWithFrame:CGRectMake((w+10)*j, h*i+w, 80, 40)];
//                lable.textColor = [UIColor darkGrayColor];
//                lable.textAlignment = NSTextAlignmentCenter;
//                lable.text = dic[@""];
//                lable.font = [UIFont systemFontOfSize:16];
//                [view addSubview:lable];
                
            }
            index+=1;
    }
    }
}
-(void)adAct:(UIButton *)btn{
    if (btn.tag<=adInfo.count) {
        NSString *iil = adInfo[btn.tag-1][@"adurl"];
        BaseViewController *vc = (BaseViewController *)[self getVCInBoard:nil ID:@"WebViewController"];
        vc.navBar.hidden = NO;
        vc.preObjvalue = iil;
        PUSH(vc);
        
        
    }
    
    
}
-(void)setHis{
    NSArray *hisArr = [self searchHis];
    if (hisArr.count>0) {
        [self.lishiLab1 setTitle:hisArr[0] forState:UIControlStateNormal];
        if (hisArr.count>1) {
            [self.lishilab2 setTitle:hisArr[1] forState:UIControlStateNormal];
        }
        if (hisArr.count>2) {
            [self.lishilab3 setTitle:hisArr[2] forState:UIControlStateNormal];
            
        }
        
    }
}
-(void)saveSearchHis{
    NSString *path = [[AppManager documentDirectoryPath] stringByAppendingPathComponent:@"searchHis.plist"];
    NSDictionary *dic = [NSDictionary dictionaryWithContentsOfFile:path];
    NSMutableArray *data = [dic[@"data"] mutableCopy];
    while (data.count>2) {
        [data removeObjectAtIndex:0];
    }
    if (!data) {
        data = [NSMutableArray array];
    }

    [data addObject:[NSString stringWithFormat:@"%@-%@",chufadiSt.name,mudidiSt.name]];
    if([@{@"data":data} writeToFile:path atomically:YES]){
        NSLog(@"保存历史成功");
    }else{
        
    }
    [self setHis];
    

}
-(NSArray *)searchHis{
    NSString *path = [[AppManager documentDirectoryPath] stringByAppendingPathComponent:@"searchHis.plist"];
    NSDictionary *dic = [NSDictionary dictionaryWithContentsOfFile:path];
    NSArray *his = dic[@"data"]; 
   his =  [[his reverseObjectEnumerator] allObjects];
    
    return his;
    
}

-(void)loadNetData{
    [[Httprequest shareRequest] postObjectByParameters:nil andUrl:@"Index/getBanner/" showLoading:YES showMsg:YES isFullUrk:NO andComplain:^(id obj) {
        NSDictionary *dict = (NSDictionary *)obj;
        if (dict) {
            bannerData = dict[@"data"];
            NSMutableArray *urls = [NSMutableArray array];
            for (NSDictionary *dic in bannerData) {
                [urls addObject:dic[@"imgurl"]];
                
            }
            bannerScrollView.imageURLStringsGroup = urls;
            
        }
    } andError:^(id error) {
        
    }];
}
-(void)setupBanner{
    
        NSArray *arr = @[@""];
    //UI元素的frame调整
    bannerScrollView = [SDCycleScrollView cycleScrollViewWithFrame:CGRectMake(0, 0, SWIDTH,SWIDTH/(375/160.0)) imageURLStringsGroup:arr];
    
    bannerScrollView.delegate = self;
    bannerScrollView.dotColor = [UIColor whiteColor]; //分页控件小圆标颜色
    bannerScrollView.pageControlDotSize = CGSizeMake(5, 5); //分页控件小圆标大小
    
    bannerScrollView.pageControlAliment = SDCycleScrollViewPageContolAlimentRight;
    bannerScrollView.autoScrollTimeInterval = 6;
    bannerScrollView.backgroundColor = [UIColor colorWithRed:0.9207 green:0.9158 blue:0.9255 alpha:1.0];
    bannerScrollView.placeholderImage = [UIImage imageNamed:@"placeH"];
    
    [self.view addSubview:bannerScrollView];

}

- (void)cycleScrollView:(SDCycleScrollView *)cycleScrollView didSelectItemAtIndex:(NSInteger)index{
    NSMutableArray *urls = [NSMutableArray array];
    for (NSDictionary *dic in bannerData) {
        [urls addObject:dic[@"linkurl"]];
        
    }
    BaseViewController *vc = (BaseViewController *)[self getVCInBoard:nil ID:@"WebViewController"];
    vc.navBar.hidden = NO;
    if (index<urls.count) {
        
  
    vc.preObjvalue = urls[index];
    
    PUSH(vc);
          }
    
    
}


-(void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event{
//    CBAlertView *vv = [[CBAlertView alloc]initWithTitle:@"提示" actionsTitles:@[@"吃",@"阿萨德刚切割人工湖",@"收到",@"碍事"] imgnames:nil showCancel:YES showSure:YES event:^(id value) {
//        
//    }];
}

-(NSString *)chineseToPinyin:(NSString *)chinese{
    //将汉字转化成拼音的代码：
    NSMutableString *mutableString = [NSMutableString stringWithString:chinese];
    CFStringTransform((CFMutableStringRef)mutableString, NULL, kCFStringTransformToLatin, false);
    CFStringTransform((CFMutableStringRef)mutableString, NULL, kCFStringTransformStripDiacritics, false);
    
    mutableString =(NSMutableString *)[mutableString stringByReplacingOccurrencesOfString:@" " withString:@""];
    return mutableString;
}
-(void)yupiaoSearchst1:(TrainStation *)station1 st2:(TrainStation *)station2{
    NSMutableDictionary *parameters = [NSMutableDictionary dictionary];
    NSString *key = @"AwCT4ccslMB3TFQ6M8H6qadrOT8ZCXVg";
    parameters[@"partnerid"] = @"bjrwx";
    parameters[@"reqtime"] = [AppManager getCurrentTimeStrWithformat:@"yyyyMMddHHmmss"];//yyyyMMddHHmmss
    NSString *md5Key = [key md5Hash];
    NSLog(@"md5Key   %@",md5Key);
    parameters[@"method"] = @"train_query";
    parameters[@"method"] = @"get_train_info";
    NSString *sign = [NSString stringWithFormat:@"%@%@%@%@",parameters[@"partnerid"],parameters[@"method"],parameters[@"reqtime"],md5Key];
    NSLog(@"sign   %@",sign);
    parameters[@"sign"] = [sign md5Hash];//md5(partnerid+method+reqtime+md5(key))
    
    
    parameters[@"train_no"] = @"240000G1010C";
    parameters[@"train_code"] = @"G101";
    
    
    
    parameters[@"train_date"] = [AppManager getCurrentTimeStrWithformat:@"yyyy-MM-dd"];//yyyy-MM-dd
    
    //    parameters[@"from_station"] = station1.szm;
    //    parameters[@"to_station"] = station2.szm;
    parameters[@"from_station"] = @"VNP";
    parameters[@"to_station"] = @"AOH";
    //    parameters[@"purpose_codes"] = @"ADULT";
    //    parameters[@"needdistance"] = @"0";
    
    NSLog(@"%@",[parameters mj_JSONString]);
    
    
    
    
    
    
    //    NSString *url = [NSString stringWithFormat:@"http://searchtrain.hangtian123.net/trainSearch?"];
    //    NSString *par = [NSString stringWithFormat:@"jsonStr=%@",[parameters mj_JSONString]];
    //    NSString *getUrl = [url stringByAppendingString:par];
    //get
    //    [[NetRequest shareRequest] requestWithUrl:getUrl parameters:nil isJsonpar:NO  isPost:NO andComplain:^(id obj) {
    //        
    //    } andError:^(id error) {
    //        
    //    }];
    
    //post
    NSString *posturl = [NSString stringWithFormat:@"http://searchtrain.hangtian123.net/trainSearch"];
    
    NSDictionary *postPar = @{@"jsonStr":[parameters mj_JSONString]};
    
    [[Httprequest shareRequest] postObjectByParameters:postPar andUrl:posturl showLoading:YES showMsg:YES isFullUrk:YES andComplain:^(id obj) {
        NSLog(@"");
    } andError:nil];


}
-(void)testLogin:(NSData *)par{
    NSURLSession *session = [NSURLSession sharedSession];
    
    NSURL *url = [NSURL URLWithString:@"http://trainorder.test.hangtian123.net/cn_interface/trainAccount/validate"];
    
    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];
    
    request.HTTPMethod = @"POST";
    
    request.HTTPBody = par;
    
    NSString *endStr = @"{\"data\":{\"trainAccount\":\"18515065942\",\"pass\":\"123456\"},\"accountversion\":\"2\"}";
    
    request.HTTPBody = [endStr dataUsingEncoding:NSUTF8StringEncoding];
    
    [request setValue:@"application/json;charset=utf-8" forHTTPHeaderField:@"Content-Type"];
    
    
    
    
    NSURLSessionDataTask *dataTask = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
        
        @try {
            NSDictionary *dict = [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:nil];
            if ([dict[@"items"] isKindOfClass:[NSArray class]]) {
                
            }
            NSLog(@"%@",dict);
        } @catch (NSException *exception) {
            
        } @finally{
            
        }
        
    }];
    [dataTask resume];
    
    
}

- (void)desTest {
    
    //    @"{\"data\":\"39HSEPWjm5doX6jaYmdJWEiTeMO4vkUP4ySl-jzTiDofhlZBvyWAdFI4H-6YYYUJ\",\"accountversion\":\"2\"}"
    
    
    
    
    NSString *plainText = @"{\"trainAccount\":\"18515065942\",\"pass\":\"123456\"}";
    
    
    NSLog(@"加密源：%@",plainText);
    
    NSString *key = @"v66r9ogtcvtxv3v4xq3gog8fqdbhwmt0";
    NSString *desBase64 = [plainText desEncryptWithKey:key];
    NSData *keydata = [key dataUsingEncoding:NSUTF8StringEncoding];
    NSData *desData = [plainText desEncryptWithDataKey:keydata];
    [desData writeToFile:@"/Users/mac/Desktop/desdata.txt" atomically:YES];
    NSLog(@"DES加密：%@ data:%@",desBase64,desData);
    
    NSString *parameters = [NSString stringWithFormat:@"{\"data\":\"%@\",\"accountversion\":\"2\"}",desBase64];
    NSLog(@"json:\n%@",parameters);
    
    [self testLogin:[parameters dataUsingEncoding:NSUTF8StringEncoding]];
    
    
    //解密
    //    NSString *decryptStr = [desBase64 desDecryptWithKey:key];
    //    NSData *data = [NSString desDecryptWithData:desData dataKey:keydata];
    //    NSLog(@"解密后：%@  ---  %@",decryptStr,data);
    
    
    
}

- (IBAction)searchAction:(UIButton *)sender {
    [self saveSearchHis];
    
    BaseViewController *vc = (BaseViewController *)[self getVCInBoard:nil ID:@"SearchResVc"];
    
    vc.preObjvalue = @[_chufadiBtn.left<_mudidiBtn.left?chufadiSt:mudidiSt,_chufadiBtn.left>_mudidiBtn.left?chufadiSt:mudidiSt,_chooeseDate.currentTitle,@(_dtdc.isOn),@(_xsp.isOn)];
    [self.navigationController pushViewController:vc animated:YES];
    
}
- (IBAction)chudfadi:(UIButton *)sender {
    BaseViewController *vc = (BaseViewController *)[self getVCInBoard:nil ID:@"ChoeseStationVC"];
    vc.touchEvent = ^(id value){
        TrainStation *st = value;
        chufadiSt = st;
        
        [sender setTitle:st.name forState:UIControlStateNormal];
        NSLog(@"选择了:%@",st.name);
    };
    PUSH(vc);
    

}
- (IBAction)mudidi:(UIButton *)sender {
    BaseViewController *vc = (BaseViewController *)[self getVCInBoard:nil ID:@"ChoeseStationVC"];
    vc.touchEvent = ^(id value){
        TrainStation *st = value;
        mudidiSt = st;
        
        [sender setTitle:st.name forState:UIControlStateNormal];
        NSLog(@"选择了:%@",st.name);
    };
    PUSH(vc);
}

- (IBAction)dateAction:(UIButton *)sender {
    [self setupDateView:DateTypeOfStart];
    
}

- (IBAction)gtdcswAction:(UISwitch *)sender {
    
}

- (IBAction)xspAction:(UISwitch *)sender {
    
}

- (IBAction)qiehuanAction:(UIButton *)sender {
//    TrainStation *st = chufadiSt;
//    chufadiSt = mudidiSt;
//    mudidiSt = st;
    [self setStaionTtile];

}
- (IBAction)lishiClick:(id)sender {
    UIButton *btn  = (UIButton *)sender;
    NSString *str = btn.currentTitle;
    
    NSString *s1 = [str componentsSeparatedByString:@"-"].firstObject;
    NSString *s2 = [str componentsSeparatedByString:@"-"].lastObject;
    
    __block TrainStation *st11;
    __block  TrainStation *st22;
    
    [self.stationArr enumerateObjectsUsingBlock:^(TrainStation * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
        if ([obj.name isEqualToString:s1]) {
            st11 = obj;
        } 
        if ([obj.name isEqualToString:s2]) {
            st22 = obj;
        } 
    }];
    chufadiSt = st11;
    mudidiSt = st22;
    [_chufadiBtn setTitle:chufadiSt.name forState:UIControlStateNormal];
    [_mudidiBtn setTitle:mudidiSt.name forState:UIControlStateNormal];
    
}
-(void)setStaionTtile{
    [UIView animateWithDuration:0.5 animations:^{
        
        CGFloat left = _chufadiBtn.left;
        _chufadiBtn.left = _mudidiBtn.left;
        _mudidiBtn.left = left;
    }];
    

}
- (void)setupDateView:(DateType)type {
    
    _pikerView = [HZQDatePickerView instanceDatePickerView];
    _pikerView.frame = CGRectMake(0, 0, SWIDTH, SHEIGHT + 20);
    [_pikerView setBackgroundColor:[UIColor clearColor]];
    _pikerView.delegate = self;
    _pikerView.type = type;
    // 今天开始往后的日期
    [_pikerView.datePickerView setMinimumDate:[NSDate date]];
//    NSDate *cur = [NSDate date];
    
    NSInteger oneDay = 24*60*60*1;  //1天的长度
    
   NSDate *theDate = [[NSDate date] initWithTimeIntervalSinceNow: +oneDay*30]; 
    // 在今天之前的日期
        [_pikerView.datePickerView setMaximumDate:theDate];
    [self.view addSubview:_pikerView];
    
}

- (void)getSelectDate:(NSString *)date type:(DateType)type {
    NSLog(@"%d - %@", type, date);
    [_chooeseDate setTitle:date forState:UIControlStateNormal];
    NSDate *date2 = [AppManager dateFromString:date format:@"yyyy-MM-dd"];
    NSString *today = [AppManager stringFromDate:[NSDate date] format:@"yyyy-MM-dd"];
    NSString *tomorrow = [AppManager stringFromDate:[NSDate dateWithTimeIntervalSinceNow:3600*24] format:@"yyyy-MM-dd"];
    NSString *afterTom = [AppManager stringFromDate:[NSDate dateWithTimeIntervalSinceNow:3600*24*2] format:@"yyyy-MM-dd"];

    if ([date isEqualToString:today]) {
        _todayLable.text = @"今天";
    }else
    if ([date isEqualToString:tomorrow]) {
        _todayLable.text = @"明天";
    }else
    if ([date isEqualToString:afterTom]) {
        _todayLable.text = @"后天";
    }else
    _todayLable.text = [HomeViewController getWeekDayFordate:[date2 timeIntervalSince1970]];
    
}
//根据时间戳获取星期几
+ (NSString *)getWeekDayFordate:(long long)data
{
    NSArray *weekday = [NSArray arrayWithObjects: [NSNull null], @"周日", @"周一", @"周二", @"周三", @"周四", @"周五", @"周六", nil];
    
    NSDate *newDate = [NSDate dateWithTimeIntervalSince1970:data];
    NSCalendar *calendar = [[NSCalendar alloc] initWithCalendarIdentifier:NSGregorianCalendar];
    NSDateComponents *components = [calendar components:NSWeekdayCalendarUnit fromDate:newDate];
    
    NSString *weekStr = [weekday objectAtIndex:components.weekday];
    return weekStr;
}

#pragma mark - 获取基本从参数
-(void)getPar{
    [[Httprequest shareRequest] postObjectByParameters:nil andUrl:@"Index/getBase/" showLoading:NO showMsg:NO isFullUrk:NO andComplain:^(id obj) {
        peizhiPar = obj[@"data"];
        
    } andError:nil];
}
-(void)getStart{
    [[Httprequest shareRequest] postObjectByParameters:nil andUrl:@"Index/getGuide/" showLoading:NO showMsg:NO isFullUrk:NO andComplain:^(id obj) {
        
        NSString *url = obj[@"data"][@"imgurl"];
        [startImageView sd_setImageWithURL:[NSURL URLWithString:url] placeholderImage:[UIImage imageNamed:@"启动页 拷贝"]];
        
        
        
    } andError:nil];
}
-(void)getAd{
    [[Httprequest shareRequest] postObjectByParameters:nil andUrl:@"Index/getAdvert/" showLoading:NO showMsg:NO isFullUrk:NO andComplain:^(id obj) {
        adInfo = obj[@"data"];
        [self setAdView:adInfo];
    } andError:nil];
    
}
-(void)getBaoxian{
    [[Httprequest shareRequest] postObjectByParameters:nil andUrl:@"Index/Insurance/" showLoading:NO showMsg:NO isFullUrk:NO andComplain:^(id obj) {
        baoxianInfo = obj[@"data"];
    } andError:nil];
}
-(void)adressInfo{
    NSString *str = [[AppManager documentDirectoryPath] stringByAppendingPathComponent:@"addressinfo.plist"];
//    NSLog(@"%@",[self parseJSONStringToNSDictionary:str]);
    
    [[Httprequest shareRequest] postObjectByParameters:nil andUrl:@"Index/getRegion/" showLoading:NO showMsg:NO isFullUrk:NO andComplain:^(id obj) {
        adressInfo = obj[@"data"];
        [adressInfo writeToFile:str atomically:YES];
    } andError:nil];
}
///解析json字符串为字典
-(NSDictionary *)parseJSONStringToNSDictionary:(NSString *)JSONString {
    NSData *JSONData = [JSONString dataUsingEncoding:NSUTF8StringEncoding];
    NSDictionary *responseJSON = [NSJSONSerialization JSONObjectWithData:JSONData options:NSJSONReadingMutableLeaves error:nil];
    return responseJSON;
}
@end
