//
//  SubmitOrderVc.m
//  CommonProject
//
//  Created by gaoguangxiao on 2017/1/8.
//  Copyright © 2017年 mac. All rights reserved.
//

#import "SubmitOrderVc.h"
#import "ChoosePerson.h"
#import "CBAlertView.h"
#import "ChangyongPsvc.h"
#import "OrderDetailAndPay.h"
#import "ShowListView.h"


@interface SubmitOrderVc ()
{
    
    CheCiRes *res;
    NSArray *baoxianInfo;
    UserInfo *shouhuoInfo;
    UIView *chooseZxView;
    
    
}
@end

@implementation SubmitOrderVc

- (void)viewDidLoad {
    [super viewDidLoad];
    if (!self.selectedCustomer) {
        
        self.selectedCustomer = [NSMutableArray array];
    }
    
    self.shengyuLab.layer.masksToBounds = YES;
    self.shengyuLab.layer.cornerRadius = 3;
    [self updateChengkeView];
    if (self.is12306dingpiao) {
        self.title = @"12306订票";
        self.zuoweiView.hidden = YES;
        self.dibuView.hidden = YES;
        self.submitBtn.top = self.chengekexinxiView.bottom+30;
        
    }else if(self.isspsm){
        self.title = @"快递到家";
        self.zuoweiView.hidden = YES;
        self.dibuView.hidden = NO;
        self.dibuView.top = self.chengekexinxiView.bottom;
        self.submitBtn.top = self.chengekexinxiView.bottom+30;
        
    }else if(self.issirendingzhi){
        self.title  = @"选择座位";
        self.zuoweiView.top = self.chengekexinxiView.bottom;
        self.dibuView.top = self.zuoweiView.bottom;

    }

    
    
   res = self.preObjvalue;
    if (![self.preObjvalue isKindOfClass:[CheCiRes class]]) {
        
        for (NSObject *obj in self.preObjvalue) {
            if ([obj isKindOfClass:[CheCiRes class]]) {
                
                res = self.preObjvalue;
                break;
            }
        }
    }
    
    
    self.chufadi.text = res.from_station_name;
    self.mudidi.text = res.to_station_name;
    self.chufashijian.text = res.start_time;
    self.daodashijian.text = res.arrive_time;
    
    
    self.chufadi.text = res.from_station_name;
    self.mudidi.text = res.to_station_name;
    
    self.lishi.text = [NSString stringWithFormat:@"%@分",[res.run_time stringByReplacingOccurrencesOfString:@":" withString:@"时"] ];
    
    self.chufashijian.text = res.start_time;
    self.daodashijian.text = res.arrive_time;
    self.checi.text = res.train_code;
    if ([res.start_station_name isEqualToString:res.from_station_name]) {
        if ([res.end_station_name isEqualToString:res.to_station_name]) {
            self.indicatorView.image = [UIImage imageNamed:@"qi-zhong"];
        }else{
            self.indicatorView.image = [UIImage imageNamed:@"qi-zhuan"];
            
        }
    }else{
        if ([res.end_station_name isEqualToString:res.to_station_name]) {
            self.indicatorView.image = [UIImage imageNamed:@"zhuan-zhong"];
        }else{
            self.indicatorView.image = [UIImage imageNamed:@"zhuan-zhuan"];
            
        }
    }
    self.zuoxi.text = self.buyedZuowei;
    self.piaojia.text = [self.buyedPrice stringByAppendingString:@"¥"];
//    20170215
    NSMutableString *ss = [NSMutableString stringWithString:res.train_start_date];
    [ss insertString:@"-" atIndex:4];
    [ss insertString:@"-" atIndex:7];

    NSString *timestr = [NSString stringWithFormat:@"%@ %@:00",ss,res.start_time] ;
    
    NSMutableString *ss2 = [NSMutableString stringWithString:res.train_start_date];
    [ss2 insertString:@"年" atIndex:4];
    [ss2 insertString:@"月" atIndex:7];
    [ss2 insertString:@"日" atIndex:10];
    
    
    NSDate *date4 = [AppManager dateFromString:timestr  format:@"yyyy-MM-dd HH:mm:ss"];

    NSString *wek = [self showWeekOrDate:date4];
    
    NSString *fache =  [NSString stringWithFormat:@"%@ %@开(%@)",ss2,res.start_time,wek] ;
    self.facehtime.text = fache;
  
    NSDate *date1 = [AppManager dateFromString:timestr format:@"yyyy-MM-dd HH:mm:ss"];
    NSDate *date2 = [NSDate date];
    NSTimeInterval time=[date1 timeIntervalSinceDate:date2];
    
    int days=((int)time)/(3600*24);
    int hours=((int)time)%(3600*24)/3600;
    int minite=(((int)time)%(3600*24)%3600)/60;

    NSString *dateContent = @"";
    
    if (days>0) {
        dateContent = [[NSString alloc] initWithFormat:@"剩余 %i天%i小时%i分",days,hours,minite];
    }else if(hours>=0 && minite>=0){
        dateContent = [[NSString alloc] initWithFormat:@"剩余 %i小时%i分",hours,minite];

    }
    self.shengyuLab.text = dateContent;
    [self.shengyuLab sizeToFit];
    self.shengyuLab.width+=10;
    self.shengyuLab.height+=8;

    
    [self updateChengkeView];
    
    
    [self getBaoxian];
    [self getShouhuo];
    
    
//    1 商务座    a c f (复选)    
//    2 一等座  ac df  (复选)    
//    3 二等座  abc df (复选)
//    4 普通座   连座 靠窗 (单选)
//    5 软卧      包间 下铺 (单选)
//    6 硬卧      至少12345张是下铺 (单选)
    if ([self.buyedZuowei containsString:@"商务座"]) {
        [self initZuoxiDingzhi:1];
    }else if ([self.buyedZuowei containsString:@"一等座"]) {
        [self initZuoxiDingzhi:2];
    }else if ([self.buyedZuowei containsString:@"二等座"]) {
        [self initZuoxiDingzhi:3];
    }else if ([self.buyedZuowei containsString:@"硬座"] || [self.buyedZuowei containsString:@"无座"]) {
        [self initZuoxiDingzhi:4];
    }else if ([self.buyedZuowei containsString:@"软卧"]) {
        [self initZuoxiDingzhi:5];
    }else if ([self.buyedZuowei containsString:@"硬卧"]) {
        [self initZuoxiDingzhi:6];
    }
    self.baoxianSW.userInteractionEnabled = NO;
}
-(void)initZuoxiDingzhi:(NSInteger)type{
//    _zxddField
    UIView *sup = self.zxddField.superview;
    
    _zxddField.hidden = YES;
    UIView *bgv ;
    if (chooseZxView) {
        [chooseZxView removeAllSubviews];
    }else{
        bgv = [[UIView alloc]initWithFrame:sup.bounds];
        [sup addSubview:bgv];
        chooseZxView = bgv;

    }

    
    if (type==1) {
        NSArray *title = @[@"窗",@"A",@"C",@"过道",@"F",@"窗"];
        int cansel[] = {0,1,1,0,1,0};
        UIButton *lst;
        for (int i=0; i<title.count; i++) {
            UIButton *btn = [self zuoweibtnWithTitle:title[i] cansel:cansel[i]];
            btn.centerY = sup.height*0.5;
            
            btn.left = lst?lst.right:0;
            lst = btn;
            [bgv addSubview:btn];
            if (i==title.count-1) {
                bgv.width = btn.right;
                bgv.centerX = sup.centerX;
            }
        }
    }else if (type==2) {
        NSArray *title = @[@"窗",@"A",@"C",@"过道",@"D",@"F",@"窗"];
        int cansel[] = {0,1,1,0,1,1,0};
        UIButton *lst;
        for (int i=0; i<title.count; i++) {
            UIButton *btn = [self zuoweibtnWithTitle:title[i] cansel:cansel[i]];
            btn.centerY = sup.height*0.5;
            
            btn.left = lst?lst.right:0;
            lst = btn;
            [bgv addSubview:btn];
            if (i==title.count-1) {
                bgv.width = btn.right;
                bgv.centerX = sup.centerX;
            }
        }
    }else if (type==3) {
        NSArray *title = @[@"窗",@"A",@"B",@"C",@"过道",@"D",@"F",@"窗"];
        int cansel[] = {0,1,1,1,0,1,1,0};
        UIButton *lst;
        for (int i=0; i<title.count; i++) {
            UIButton *btn = [self zuoweibtnWithTitle:title[i] cansel:cansel[i]];
            btn.centerY = sup.height*0.5;
            
            btn.left = lst?lst.right:0;
            lst = btn;
            [bgv addSubview:btn];
            if (i==title.count-1) {
                bgv.width = btn.right;
                bgv.centerX = sup.centerX;
            }
        }
    }else if(type==4){
        UIButton *btn = [self zuoweibtnWithTitle:@"选择座位类型" cansel:NO];
        btn.width = SWIDTH-30;
        btn.left = 15;
        [bgv addSubview:btn];
        bgv.left = 0;
        btn.tag = 4;
        [btn addTarget:self action:@selector(chooseLeixing:) forControlEvents:UIControlEventTouchUpInside];
        
        btn.centerY = bgv.height*0.5;
        
    }else if(type==5){
        UIButton *btn = [self zuoweibtnWithTitle:@"选择座位类型" cansel:NO];
        btn.width = SWIDTH-30;
        btn.left = 15;
        [bgv addSubview:btn];
        bgv.left = 0;
        btn.tag = 5;
        [btn addTarget:self action:@selector(chooseLeixing:) forControlEvents:UIControlEventTouchUpInside];
        
        btn.centerY = bgv.height*0.5;
        
    }else if (type==6){
        UIButton *btn = [self zuoweibtnWithTitle:@"选择座位类型" cansel:NO];
        btn.width = SWIDTH-30;
        btn.left = 15;
        [bgv addSubview:btn];
        bgv.left = 0;
        btn.tag = 6;
        [btn addTarget:self action:@selector(chooseLeixing:) forControlEvents:UIControlEventTouchUpInside];
        
        btn.centerY = bgv.height*0.5;
    }
}
-(void)chooseLeixing:(UIButton *)btn{
    CGRect frame = [btn.superview convertRect:btn.frame toView:self.scrollview];
    NSArray *a1 = @[@"优先连座",@"优先靠窗"];
    NSArray *a2 = @[@"优先包间",@"优先下铺"];
    NSArray *a3 = @[@"至少1张下铺",@"至少2张下铺",@"至少3张下铺",@"至少4张下铺",@"至少5张下铺"];
    NSArray *arr ;
    
    if (btn.tag == 4) {
        arr = a1;
        
    }
    if (btn.tag == 5) {
        arr = a2;
        
    }
    if (btn.tag == 6) {
        arr = a3;
        
    }
     ShowListView *show = [[ShowListView alloc]initWithFrame:CGRectMake(0, CGRectGetMaxY(frame), SWIDTH, arr.count*40) dataSource1:arr ClickEvent:^(NSString *title, NSInteger index) {
         [btn setTitle:title forState:UIControlStateNormal];
         btn.selected = YES;
     } andPostName:nil];
    [self.scrollview addSubview:show];
    
}
-(UIButton *)zuoweibtnWithTitle:(NSString *)title cansel:(BOOL)cansele{
    
    UIButton *btn = [[UIButton alloc]initWithFrame:CGRectMake(10, 10, 40, 40)];
    [btn setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
    btn.titleLabel.font = Font(15);
    
    if (cansele) {
        [btn setImage:[UIImage imageNamed:@"weixuanzhong"] forState:UIControlStateNormal];
        [btn setImage:[UIImage imageNamed:@"xuanzhong"] forState:UIControlStateSelected];
        [btn setTitle:[NSString stringWithFormat:@" %@",title] forState:UIControlStateNormal];
        [btn addTarget:self action:@selector(zuoweibtnAction:) forControlEvents:UIControlEventTouchUpInside];
        btn.tag = 10;
    }else{
        
        [btn setTitle:[NSString stringWithFormat:@"%@",title] forState:UIControlStateNormal];
    }
    
    return btn;
}
-(void)zuoweibtnAction:(UIButton *)btn{
    if ([self.buyedZuowei containsString:@"软卧"] || [self.buyedZuowei containsString:@"硬座"] || [self.buyedZuowei containsString:@"无座"]) {
        for (UIButton *b  in chooseZxView.subviews) {
            if ([b isKindOfClass:[UIButton class]]) {
                b.selected = NO;
            }
        }
        btn.selected = YES;
    }else
    btn.selected = !btn.selected;
}
-(NSString *)showWeekOrDate:(NSDate *)date{
    NSString *dateStr = [AppManager stringFromDate:date format:@"yyyy-MM-dd"];
    NSString *today = [AppManager stringFromDate:[NSDate date] format:@"yyyy-MM-dd"];
    NSString *tomorrow = [AppManager stringFromDate:[NSDate dateWithTimeIntervalSinceNow:3600*24] format:@"yyyy-MM-dd"];
    NSString *afterTom = [AppManager stringFromDate:[NSDate dateWithTimeIntervalSinceNow:3600*24*2] format:@"yyyy-MM-dd"];
    NSString *newStr = @"";
    
    if ([dateStr isEqualToString:today]) {
        newStr = @"今天";
    }else
        if ([dateStr isEqualToString:tomorrow]) {
            newStr = @"明天";
        }else
            if ([dateStr isEqualToString:afterTom]) {
                newStr = @"后天";
            }else
                newStr = [SubmitOrderVc getWeekDayFordate:[date timeIntervalSince1970]];
    return newStr;
    
}
//根据时间戳获取星期几
+ (NSString *)getWeekDayFordate:(long long)data
{
    NSArray *weekday = [NSArray arrayWithObjects: [NSNull null], @"周日", @"周一", @"周二", @"周三", @"周四", @"周五", @"周六", nil];
    
    NSDate *newDate = [NSDate dateWithTimeIntervalSince1970:data];
    NSCalendar *calendar = [[NSCalendar alloc] initWithCalendarIdentifier:NSGregorianCalendar];
    NSDateComponents *components = [calendar components:NSWeekdayCalendarUnit fromDate:newDate];
    
    NSString *weekStr = [weekday objectAtIndex:components.weekday];
    return weekStr;
}

-(void)getShouhuo{
    [_qupiaofangshi setTitle:@"快递到家" forState:UIControlStateNormal];
//    _qupiaofangshi.userInteractionEnabled = NO;
    if (!UToken) {
//        [LoadingView showAMessage:@"未登录"];
        return;
    }
    [[Httprequest shareRequest] postObjectByParameters:[self getparametersWithDic:@{@"UToken":UToken}] andUrl:@"Action/userInfo/" showLoading:YES showMsg:YES isFullUrk:NO andComplain:^(id obj) {
        if ([obj[@"code"] integerValue] == 1) {
            NSDictionary *infoDic = obj[@"data"];
            
            shouhuoInfo = [UserInfo mj_objectWithKeyValues:infoDic];
            if (shouhuoInfo.take_province) {
                _shoujianxixi.titleLabel.numberOfLines = 0;
                [_shoujianxixi setTitle:[NSString stringWithFormat:@"%@ %@ %@",shouhuoInfo.take_uname,shouhuoInfo.take_pcc,shouhuoInfo.take_address] forState:UIControlStateNormal];
                _shoujihao.text = shouhuoInfo.take_phone;
            } 
        }
    } andError:nil];
}
-(void)getBaoxian{
    [[Httprequest shareRequest] postObjectByParameters:nil andUrl:@"Index/Insurance/" showLoading:NO showMsg:NO isFullUrk:NO andComplain:^(id obj) {
         baoxianInfo = obj[@"data"];
        [self updateChengkeView];
    } andError:nil];
}
-(void)updateChengkeView{
    
    
    [UIView animateWithDuration:0.3 animations:^{
        CGFloat height = self.selectedCustomer.count*50 + 75;
        self.chengekexinxiView.height = height;
        self.chengekexinxiView.clipsToBounds = YES;
        
        NSInteger index= 100 ;
        for (Customer *cus in self.selectedCustomer) {
            UIView *view = [self.cklistView viewWithTag:index];
            UILabel *l1 = [view viewWithTag:10];
            l1.text = cus.name;
            UILabel *l2 = [view viewWithTag:11];
            l2.text = cus.type_name;
            UILabel *l3 = [view viewWithTag:12];
            l3.text = cus.id_number;
            
            
            
            
            index+=1;
        }
        
        
        if (self.is12306dingpiao) {
            self.submitBtn.top = self.chengekexinxiView.bottom+30;
            
        }else if(self.isspsm){
            self.dibuView.top = self.chengekexinxiView.bottom;
            self.submitBtn.top = self.dibuView.bottom+30;

        }else if(self.issirendingzhi){
            self.zuoweiView.top = self.chengekexinxiView.bottom;
            self.dibuView.top = self.zuoweiView.bottom;
            self.submitBtn.top = self.dibuView.bottom+30;

        }
        
        CGFloat hh =  self.submitBtn.bottom+30;
        
        if (hh<=self.scrollview.height) {
            hh=self.scrollview.height+1;
        }
        self.scrollview.contentSize = CGSizeMake(SWIDTH, hh);    } completion:nil];

    
    
    
    
    CGFloat money = [self.buyedPrice floatValue];
    CGFloat singleIns = 0.0;
    
    if (baoxianInfo) {
        for (NSDictionary *ins in baoxianInfo) {
            if (ins[@"insurance_type"] && [ins[@"insurance_type"] integerValue]==3) {
                CGFloat min = [ins[@"min_val"] floatValue];
                CGFloat max = [ins[@"max_val"] floatValue];
                if (money<max && money>min) {
                    singleIns = [ins[@"money"] floatValue];
                    break;
                }
            }
        }      
        
    }
    _baoxianlable.text = [NSString stringWithFormat:@"%.1f元/份",singleIns];
    
        
}


- (IBAction)deleteck:(UIButton *)sender {
    NSInteger index = sender.superview.tag - 100;
    if (index<self.selectedCustomer.count) {
        [self.selectedCustomer removeObjectAtIndex:index];
        [self updateChengkeView];
    }
}
- (IBAction)tjckAction:(UIButton *)sender {
    BOOL isLogin = [[NSUserDefaults standardUserDefaults]boolForKey:@"isrxlogin"];
    
    if (!self.is12306dingpiao && !isLogin) {
        
        BaseViewController *vcv = (BaseViewController *)[AppManager getVCInBoard:nil ID:@"LoginVc"];
        
        vcv.preObjvalue = @"SubmitOrder";
        PUSH(vcv);
        return;
    }
    
    
    
    ChoosePerson *vc = (ChoosePerson *)[self getVCInBoard:nil ID:@"ChoosePerson"];
    vc.preObjvalue = self.selectedCustomer;
    vc.ischoose12306 = self.is12306dingpiao;
    
    __weak typeof(self) weakSelf = self;
    vc.touchEvent = ^(id value){
        if ([value isKindOfClass:[NSArray class]]) {
            self.selectedCustomer = value;
            [weakSelf updateChengkeView];
        }  
    };
    PUSH(vc);
}


-(CGFloat)getMaxPrice{
    
    NSString *maxStr = @"";
    if ([self.buyedZuoweiCode containsString:@"硬卧"]) {
        maxStr = @"ywx_price";
    }else if ([self.buyedZuoweiCode containsString:@"高级软卧"]) {
        maxStr = @"gjrw_price";
        
    }else if ([self.buyedZuoweiCode containsString:@"软卧"]) {
        maxStr = @"rwx_price";
    }else {
        maxStr = self.buyedZuoweiCode;
    }
    CGFloat maxP = 0;
    maxP = [[[res mj_keyValues] objectForKey:maxStr] floatValue];
    
    return maxP;
    
    
}


#pragma mark - 点击提交订单
- (IBAction)submitAction:(UIButton *)sender {
    if (self.selectedCustomer.count<1) {
        [LoadingView showAMessage:@"请先选择乘客"];
        return;
    } 

    BOOL isrxlogin = [[NSUserDefaults standardUserDefaults]boolForKey:@"isrxlogin"];
    
    if (!isrxlogin) {
        
        BaseViewController *vcv = (BaseViewController *)[AppManager getVCInBoard:nil ID:@"LoginVc"];
        
        vcv.preObjvalue = @"SubmitOrder";
        PUSH(vcv);
        return;
    }
    
    
    if (self.issirendingzhi && self.shoujihao.text.length<5) {
        [LoadingView showAMessage:@"请填写手机号"];
        return;
    }
    CheCiRes *checi = res;
    
    if (!checi) {
        return;
    }
    NSMutableDictionary *par = [NSMutableDictionary dictionary];
    par[@"UToken"] = UToken;
    par[@"checi"] = checi.train_code;
    par[@"from_station_code"] = checi.from_station_code;
    par[@"from_station_name"] = checi.from_station_name;
    par[@"to_station_code"] = checi.to_station_code;
    par[@"to_station_name"] = checi.to_station_name;
   
    par[@"runtime"] = checi.run_time;
    par[@"is_accept_standing"] = @0 ;
    
    if ([self.buyedZuowei isEqualToString:@"无座"]) {
        par[@"is_accept_standing"] = @1 ;
        
    }
    NSMutableString *ss = [NSMutableString stringWithString:res.train_start_date];
    [ss insertString:@"-" atIndex:4];
    [ss insertString:@"-" atIndex:7];
    
    par[@"train_date"] = ss;
    par[@"start_time"] = [NSString stringWithFormat:@"%@ %@:00" ,ss,checi.start_time];
    
    par[@"arrive_time"] = [NSString stringWithFormat:@"%@ %@:00" ,ss,checi.arrive_time];
    
    NSString *postUrl = @"Action/createBuyTicketOnline/";
    
    if (self.is12306dingpiao) {
        
        NSString *LoginUserName = [[NSUserDefaults standardUserDefaults] objectForKey:@"zh12306"];
        NSString *LoginUserPassword = [[NSUserDefaults standardUserDefaults] objectForKey:@"mm12306"];
        
        par[@"LoginUserName"] = LoginUserName;
        par[@"LoginUserPassword"] = LoginUserPassword;
       
        
        NSMutableArray *passengers = [NSMutableArray array];
        //        坐席类型CODE,9:商务座，P:特等座，M:一等座，O:二等座，6:高级软卧，4:软卧，3:硬卧，2:软座，1:硬座
        //        票类型;1:成人票，2:儿童票，3:学生票，4:残军票
        NSString *zwcode = [self zuoweiCodeWithName:self.buyedZuowei];
        
        for (Customer *cus in self.selectedCustomer) {
            NSDictionary *passeng = @{@"passengersename":cus.name,@"passportseno":cus.id_number,@"passporttypeseidname":cus.id_name,@"passporttypeseid":@(cus.id_type),@"passengerid":cus.passengerid,@"zwname":self.buyedZuowei,@"zwcode":zwcode,@"price":self.buyedPrice,@"piaotype":@"1",@"cxin":@""};
            
            [passengers addObject:passeng];
        }
        
        
        par[@"passengers"] = passengers;

    }else {

        postUrl = @"Action/createBuyTicketOffline/";
        
        
        NSMutableString *dingzhiStr = [NSMutableString string];
        
        for (UIButton *btn in chooseZxView.subviews) {
            if (btn.selected) {
                [dingzhiStr appendString:[NSString stringWithFormat:@"%@,",btn.currentTitle]];
            }
        }
        NSLog(@"%@",dingzhiStr);
        
        par[@"prompt_message"] = dingzhiStr;

        
        par[@"take_uname"] = @"张三";
        par[@"take_phone"] = _shoujihao.text;
        
        par[@"sendtype"] = @"2";
        NSInteger sendtype = 2;
        if ([_qupiaofangshi.currentTitle isEqualToString:@"快递到家"]) {
            par[@"sendtype"] = @"1";
            sendtype = 1;
            
        }
        if (sendtype==1) {
            if (!shouhuoInfo) {
                [LoadingView showAMessage:@"请选择收件信息"];
                return;
            }
            par[@"take_province"] = shouhuoInfo.take_province;
            par[@"take_city"] = shouhuoInfo.take_city;
            par[@"take_county"] = shouhuoInfo.take_county;
            par[@"take_address"] = shouhuoInfo.take_address;
        }
        
        CGFloat maxP = [self getMaxPrice];
        
        par[@"max_price"] = @(maxP);

        //乘客信息
        NSMutableArray *passengers = [NSMutableArray array];
        for (Customer *cus in self.selectedCustomer) {
            NSString *zwcode = [self zuoweiCodeWithName:self.buyedZuowei];
            NSDictionary *passeng = @{@"contacts_id":cus.passengerid,@"zwcode":zwcode,@"piaotype":@"1",@"cxin":@""};
            
            [passengers addObject:passeng];
        }
        par[@"passengers"] = passengers;

        CGFloat money = [self.buyedPrice floatValue];
        CGFloat singleIns = 0.0;
        
        if (baoxianInfo) {
            for (NSDictionary *ins in baoxianInfo) {
                if (ins[@"insurance_type"] && [ins[@"insurance_type"] integerValue]==3) {
                    CGFloat min = [ins[@"min_val"] floatValue];
                    CGFloat max = [ins[@"max_val"] floatValue];
                    if (money<max && money>min) {
                        singleIns = [ins[@"money"] floatValue];
                        break;
                    }
                }
            }      
            
        }
        
        
        par[@"insurance"] = @(singleIns);
        par[@"all_insurance"] = @(singleIns*passengers.count);
        



    }
    
               

        
        
        [[Httprequest shareRequest] postObjectByParameters:[self getparametersWithDic:par] andUrl:postUrl showLoading:YES showMsg:YES isFullUrk:NO andComplain:^(id obj) {
            if ([obj[@"code"] integerValue] == 1) {
//                [self.navigationController popToRootViewControllerAnimated:YES];
                NSString *orderid = obj[@"data"][@"orderid"];
                
                OrderDetailAndPay *vc = (OrderDetailAndPay *)[self getVCInBoard:nil ID:@"OrderDetailAndPay"];
                
                vc.orderid = orderid;
                vc.url = self.is12306dingpiao?@"Action/buyRowOnline/":@"Action/buyRowOffline/";
                vc.tuipiaoUrl = self.is12306dingpiao?@"Action/buyOnlineReturn/":@"Action/buyOfflineReturn/";
                PUSH(vc);
            }
        } andError:^(id error) {
            
        }];   
    
}
-(NSString *)zuoweiCodeWithName:(NSString *)name{
    //        坐席类型CODE,9:商务座，P:特等座，M:一等座，O:二等座，6:高级软卧，4:软卧，3:硬卧，2:软座，1:硬座

        NSString *code = @"";
    if ([name isEqualToString:@"商务座"]) {
        code = @"9";
    }else if ([name isEqualToString:@"特等座"]) {
        code = @"P";
    }else if ([name isEqualToString:@"一等座"]) {
        code = @"M";
    }else if ([name isEqualToString:@"二等座"]) {
        code = @"O";
    }else if ([name isEqualToString:@"高级软卧"]) {
        code = @"6";
    }else if ([name isEqualToString:@"软卧"]) {
        code = @"4";
    }else if ([name isEqualToString:@"硬卧"]) {
        code = @"3";
    }else if ([name isEqualToString:@"软座"]) {
        code = @"2";
    }else if ([name isEqualToString:@"硬座"]) {
        code = @"1";
    }
    return code;
}
- (IBAction)qupiao:(UIButton *)sender {
    NSArray *arr = @[@"快递到家",@"火车站配送"];
    CBAlertView *view = [[CBAlertView alloc]initWithTitle:@"请选取取票方式" actionsTitles:arr imgnames:nil showCancel:YES showSure:NO event:^(id value) {
        [sender setTitle:arr[[value integerValue]] forState:UIControlStateNormal];
        NSString *sss = arr[[value integerValue]];
        
        if ([sss isEqualToString:@"火车站配送"]) {
            [self.shoujianxixi setTitle:res.from_station_name forState:UIControlStateNormal];
            
        }else{
            
            
            NSString *str = [NSString stringWithFormat:@"%@ %@",shouhuoInfo.take_uname,shouhuoInfo.take_pcc];
            [self.shoujianxixi setTitle:str forState:UIControlStateNormal];

        }
        
    }];
}
- (IBAction)shoujianact:(UIButton *)sender {
    ChangyongPsvc *vc = (ChangyongPsvc *)[self getVCInBoard:@"Main" ID:@"ChangyongPsvc"];
    vc.isfromChoose = YES;
    
    vc.touchEvent = ^(UserInfo *info){
        shouhuoInfo = info;
        _shoujianxixi.titleLabel.numberOfLines = 0;
        [_shoujianxixi setTitle:[NSString stringWithFormat:@"%@ %@ %@",shouhuoInfo.take_uname,shouhuoInfo.take_pcc,shouhuoInfo.take_address] forState:UIControlStateNormal];
        _shoujihao.text = shouhuoInfo.take_phone;

        
    };
    PUSH(vc);
    
}

@end
