//
//  RegisterVc.m
//  CommonProject
//
//  Created by mac on 2017/1/10.
//  Copyright © 2017年 mac. All rights reserved.
//

#import "RegisterVc.h"
#import "NSString+Hash.h"
#import "CocoaSecurity.h"
#import "NSString+Encryption.h"
#import "RSA.h"
@interface RegisterVc ()

@end

@implementation RegisterVc

- (void)viewDidLoad {
    [super viewDidLoad];
//    if (self.next) {
//        _phoneField.text = @"a111111";
//        _pwdField.text = @"a111111";
//        _yqmfield.text = @"11111111";
//    }else{
//        _phoneField.text = @"hechangben";
//        _pwdField.text = @"18610813753";
//        
//    }
        _nextBtn.backgroundColor = BlueColor;
}

-(void)textFieldDidEndEditing:(UITextField *)textField{
    if (_phoneField.text.length<1) {
        
        
        if (_phoneBtn.height<30) {
            
            
            [UIView animateWithDuration:0.2 animations:^{
                _phoneBtn.height = 44;
                _phoneBtn.titleLabel.font = Font(15);
            }];
        }
    }
    
    if (_pwdField.text.length<1) {
        
        if (_pwdBtn.height<30) {
            
            
            [UIView animateWithDuration:0.2 animations:^{
                _pwdBtn.height = 44;
                _pwdBtn.titleLabel.font = Font(15);
            }];
        }
    }
    
    if (_yzmField.text.length<1) {
        
        if (_yanzmBtn.height<30) {
            
            
            [UIView animateWithDuration:0.2 animations:^{
                _yanzmBtn.height = 44;
                _yanzmBtn.titleLabel.font = Font(15);
            }];
        }
    }
    if (_yqmfield.text.length<1) {
        
        if (_yqmbtn.height<30) {
            
            
            [UIView animateWithDuration:0.2 animations:^{
                _yqmbtn.height = 44;
                _yqmbtn.titleLabel.font = Font(15);
            }];
        }
    }

    if (self.next) {
        if (_phoneField.text.length<1) {
            return;
        }
        if (_pwdField.text.length<1) {
            return;
        }
        if (_yqmfield.text.length<4 ){
            return;
        }
        _zhuceanniu.backgroundColor = BlueColor;

    }else{
        if (_phoneField.text.length<1) {
            return;
        }
        if (_pwdField.text.length<1) {
            return;
        }
        if (_yzmField.text.length<4 ){
            return;
        }

    }
    _nextBtn.backgroundColor = BlueColor;
    
}
- (IBAction)mimaact:(UIButton *)sender {
    UIButton *btn = (UIButton *)sender;
    _phoneField.hidden = NO;
    
    if (btn.height>30) {
        [_phoneField becomeFirstResponder];
        
        [UIView animateWithDuration:0.2 animations:^{
            btn.height = 15;
            btn.titleLabel.font = Font(13);
        }];
    }

}
- (IBAction)querenact:(UIButton *)sender {
    UIButton *btn = (UIButton *)sender;
    _pwdField.hidden = NO;
    
    if (btn.height>30) {
        [_pwdField becomeFirstResponder];
        
        [UIView animateWithDuration:0.2 animations:^{
            btn.height = 15;
            btn.titleLabel.font = Font(13);
        }];
    }
}

- (IBAction)yaoqingmaact:(UIButton *)sender {
    UIButton *btn = (UIButton *)sender;
    _yqmfield.hidden = NO;
    
    if (btn.height>30) {
        [_yqmfield becomeFirstResponder];
        
        [UIView animateWithDuration:0.2 animations:^{
            btn.height = 15;
            btn.titleLabel.font = Font(13);
        }];
    }

}
- (IBAction)yhm:(UIButton *)sender {
    UIButton *btn = (UIButton *)sender;
    _phoneField.hidden = NO;
    
    if (btn.height>30) {
        [_phoneField becomeFirstResponder];
        
        [UIView animateWithDuration:0.2 animations:^{
            btn.height = 15;
            btn.titleLabel.font = Font(13);
        }];
    }

}
- (IBAction)sjh:(UIButton *)sender {
    UIButton *btn = (UIButton *)sender;
    _pwdField.hidden = NO;
    
    if (btn.height>30) {
        [_pwdField becomeFirstResponder];
        
        [UIView animateWithDuration:0.2 animations:^{
            btn.height = 15;
            btn.titleLabel.font = Font(13);
        }];
    }

}
- (IBAction)yzm:(UIButton *)sender {
    UIButton *btn = (UIButton *)sender;
    _yzmField.hidden = NO;
    
    if (btn.height>30) {
        [_yzmField becomeFirstResponder];
        
        [UIView animateWithDuration:0.2 animations:^{
            btn.height = 15;
            btn.titleLabel.font = Font(13);
        }];
    }
}

- (IBAction)nextAction:(UIButton *)sender {
    if (_phoneField.text.length<1) {
        [LoadingView showAMessage:@"请填写用户名"];
        return;
    }
    if (_pwdField.text.length<1) {
        [LoadingView showAMessage:@"请填写手机号"];

        return;
    }
    if (_yzmField.text.length<1 ){
        [LoadingView showAMessage:@"请填写验证码"];

        return;
    }
    RegisterVc *vc = (RegisterVc *)[self getVCInBoard:nil ID:@"RegisterVc2"];
    vc.next = YES;
    vc.preObjvalue = @[_phoneField.text,_pwdField.text,_yzmField.text];
    PUSH(vc);
    
}

- (IBAction)zhuceSureAct:(UIButton *)sender {
    
    if (_phoneField.text.length<1) {
        [LoadingView showAMessage:@"请填写密码"];

        return;
    }
    if (_pwdField.text.length<1) {
        [LoadingView showAMessage:@"请再次填写密码"];

        return;
    }

    [self submitLogin];
    

}

//因为NSDictionary没有compare的排序比较方法，所以需要我们自己写一个
- (NSComparisonResult)compare: (NSDictionary *)otherDictionary{
    NSDictionary *tempDictionary = (NSDictionary *)self;
    
    NSNumber *number1 = [[tempDictionary allKeys] objectAtIndex:0];
    NSNumber *number2 = [[otherDictionary allKeys] objectAtIndex:0];
    NSComparisonResult result = [number1 compare:number2];
    
    return result == NSOrderedDescending; // 升序
    //    return result == NSOrderedAscending;  // 降序
}
-(void)submitLogin{
    NSArray *prevalue = self.preObjvalue;
    if (prevalue.count!=3) {
        [LoadingView showAMessage:@"注册信息不完整"];
        return;
    }
    NSMutableDictionary *par = [NSMutableDictionary dictionary];
    par[@"account"] = prevalue[0];
    par[@"phone"] = prevalue[1];
    par[@"verifycode"] = prevalue[2];
    par[@"pwd"] = _pwdField.text;
    if (_yqmfield.text.length>0) {
        
        par[@"inviter"] = _yqmfield.text;
    }
  
    
    
   

    NSString *lastStr = @"";
    NSArray *allK = par.allKeys;
    NSArray *resultArray = [allK sortedArrayUsingSelector:@selector(compare:)];

    
    for (NSString *key in resultArray) {
        lastStr = [lastStr stringByAppendingFormat:@"%@=%@&",key,par[key]];
    }
    if (lastStr.length>2) {
        lastStr = [lastStr substringToIndex:lastStr.length-1];
    }

    NSString *apiKey = @"802a657325e71d88";

    NSString *SN = [NSString stringWithFormat:@"%@&key=%@",lastStr,apiKey];
    NSString *SNMD5 = SN.md5Hash;
    
    
    par[@"SN"]  = [AppManager md5To16:SNMD5];
    NSDictionary *postPar = @{@"data":[par mj_JSONString]};

    
    [[Httprequest shareRequest] postObjectByParameters:postPar andUrl:@"Action/reg/" showLoading:YES showMsg:YES isFullUrk:NO andComplain:^(id obj) {
        NSDictionary *dic = obj;

        if ([dic[@"code"] integerValue] == 1) {
            if (dic[@"data"]) {
                NSString *tk = dic[@"data"][@"UToken"];
                [[NSUserDefaults standardUserDefaults]setObject:tk forKey:@"UToken"];
                [LoadingView showAMessage:@"注册成功"];
                POP;
                 POP;
                
            }
        }
    } andError:^(id error) {
        
    }];
    
//http://192.168.1.210/Action/reg/data={"verifycode":"312321","account":"2341432","phone":"3121242","SN":"b492d80552dff19f","pwd":"1234312","inviter":"123312"}
}

- (IBAction)huoquyam:(UIButton *)sender {
    if (_pwdField.text.length<1) {
        
        return;
    }
    [[Httprequest shareRequest] postObjectByParameters:[self getparametersWithDic:@{@"phone":_pwdField.text,@"isreg":@1}] andUrl:@"Action/sendMsg/" showLoading:YES showMsg:YES isFullUrk:NO andComplain:^(id obj) {
        NSDictionary *dic = obj;
        
        if ([dic[@"code"] integerValue] == 1) {
             [self startTime:sender];
            [LoadingView showAMessage:dic[@"result"]];
        }
    } andError:^(id error) {
        
    }];
    
//http://192.168.1.210/Action/sendMsg&data={"phone":"18610813753","isreg":1,"SN":"bb5c01021b18da66"}
   
    
}
- (IBAction)tianxieAct:(UIButton *)sender {
    
}
-(void)startTime:(UIButton *)l_timeButton{
    
    //    UIButton *l_timeButton = self.getyzmBtn;
    __block int timeout=60; //倒计时时间
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    dispatch_source_t _timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0,queue);
    dispatch_source_set_timer(_timer,dispatch_walltime(NULL, 0),1.0*NSEC_PER_SEC, 0); //每秒执行
    dispatch_source_set_event_handler(_timer, ^{
        if(timeout<=0){ //倒计时结束，关闭
            dispatch_source_cancel(_timer);
            dispatch_async(dispatch_get_main_queue(), ^{
                //设置界面的按钮显示 根据自己需求设置
                [l_timeButton setTitle:@"获取验证码" forState:UIControlStateNormal];
                l_timeButton.userInteractionEnabled = YES;
                l_timeButton.enabled = YES;
            });
        }else{
            //            int minutes = timeout / 60;
            int seconds = timeout;
            
            NSString *strTime = [NSString stringWithFormat:@"%.2d", seconds];
            dispatch_async(dispatch_get_main_queue(), ^{
                //设置界面的按钮显示 根据自己需求设置
                ////NSLog(@"____%@",strTime);
                //                l_timeButton.titleLabel.font = Font(14);
                [l_timeButton setTitle:[NSString stringWithFormat:@"%@秒后重发",strTime] forState:UIControlStateNormal];
                l_timeButton.userInteractionEnabled = NO;
                
            });
            timeout--;
            
        }
    });
    dispatch_resume(_timer);
    
}

@end
