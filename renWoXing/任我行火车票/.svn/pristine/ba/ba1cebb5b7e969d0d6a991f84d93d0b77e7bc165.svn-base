//
//  DZXZVc.m
//  CommonProject
//
//  Created by gaoguangxiao on 2017/1/7.
//  Copyright © 2017年 mac. All rights reserved.
//

#import "DZXZVc.h"
#import "LDCalendarView.h"
#import "NSDate+extend.h"
#import "SearchResVc.h"
#import "ChooseDateViewController.h"
#import "ChooseSeatTypeVc.h"
#import "PayView.h"
#import "SubmitOrderVc.h"
#import "ChoosePerson.h"
#import "CBAlertView.h"
#import "ChangyongPsvc.h"
#import "OrderDetailAndPay.h"


@interface DZXZVc ()
{
    TrainStation *chufadiSt;
    TrainStation *mudidiSt;
NSArray *baoxianInfo;
    NSMutableArray <Customer *>*selectedCustomer;
    NSMutableArray <DateObject *>*selectedDate;
    NSMutableArray <SeatType *>*selectedType;

    NSMutableArray *selectedCheci;

    NSString *train_date;
    UIView *qpxinxi ;//抢票信息模块
    UIView *psxinxi;//配送信息模块
    PayView *payView ;
    
    
    UserInfo *shouhuoInfo;
    
    //人工
    UITextField *shoujihao;
    UILabel *zuigaopiaojia;
    
    //12306的
    UIButton *qupiaofangshi;
    UIButton *shoujianxinxi;
    UILabel *baoxianLable;
    CGFloat baoxianPrice;
    
    
}
@property (nonatomic,assign)BOOL issingle;//是否是单选



@end

@implementation DZXZVc

- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.navBar.hidden = NO;
    selectedCustomer = [NSMutableArray array];
    selectedDate = [NSMutableArray array];
    selectedCheci = [NSMutableArray array];
    selectedType = [NSMutableArray array];
    
    
    
    
    
    if (self.from == 1 || self.from==2 || self.from==3) {
        self.title = self.preObjvalue;
        self.issingle = YES;
    }
    if (self.from==4) {
        self.title = @"添加12306抢票任务";
    }else if (self.from == 5){
        self.title = @"添加人工抢票任务";
        self.issingle = YES;
        
    }
  
    
    //初始化公用视图和数据
    [self initCommonData];
    
    
    //初始化上个界面所选择的车次信息
    //说明是从查询某一趟车的结果页面过来的，进入添加抢票页面时，需要把所选的车次信息填入
    if ([self.preObjvalue isKindOfClass:[CheCiRes class]]) {
        CheCiRes *result = self.preObjvalue;
        
        [self.stationArr enumerateObjectsUsingBlock:^(TrainStation * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            if ([obj.szm isEqualToString:result.from_station_code]) {
                chufadiSt = obj;
            } 
            if ([obj.szm isEqualToString:result.to_station_code]) {
                mudidiSt = obj;
            } 
        }];
        [self setStaionTtile];
        DateObject *date = [[DateObject alloc]init];

        if (result.train_start_date.length==8) {
            NSMutableString *s = [NSMutableString stringWithString:result.train_start_date];
            [s insertString:@"-" atIndex:4];
            [s insertString:@"-" atIndex:7];
            
            
            date.showStr = s;
            date.originalStr = s;
        }
        [selectedDate addObject:date];
        [selectedCheci addObject:result];
    }
    if (self.buyedZuowei) {
        SeatType *yy = [[SeatType alloc]init];
        yy.name = self.buyedZuowei;
        yy.type_name = self.buyedZuoweiCode;
        [selectedType addObject:yy];
    }
    [self showSeattype];
    [self showDate];
    [self showCheci];
    
    
    
    
    
    
    if (self.from==4) {
        [self init12306QP];
    }else if (self.from ==  5){
        [self initRGQP];
    }else if (self.from ==  6){
//        [self initRGQP];
        self.issingle = YES;

        self.title = @"快递到家";

    }else if (self.from ==  7){
//        [self initRGQP];
        self.issingle = YES;
        self.title = @"私人订制";
    }
    [self updateChengkeView];
    
    if (self.issingle) {
        self.riqiBtn.userInteractionEnabled = NO;
        if (![self.preObjvalue isKindOfClass:[CheCiRes class]]) {
            
            [self.riqiBtn setTitle:[AppManager stringFromDate:[NSDate date] format:@"yyyy-MM-dd'"] forState:UIControlStateNormal];
        }
        [self.duoxuanBtns enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            UIButton *btn = obj;
            btn.hidden = YES;
            
        }];
    }
    
    [self getBaoxian];
    [self getShouhuo];
    
    
}
-(void)getBaoxian{
    [[Httprequest shareRequest] postObjectByParameters:nil andUrl:@"Index/Insurance/" showLoading:NO showMsg:NO isFullUrk:NO andComplain:^(id obj) {
        baoxianInfo = obj[@"data"];
    } andError:nil];
}
-(void)getShouhuo{
    if (!UToken) {
        
        return;
    }
    [[Httprequest shareRequest] postObjectByParameters:[self getparametersWithDic:@{@"UToken":UToken}] andUrl:@"Action/userInfo/" showLoading:YES showMsg:YES isFullUrk:NO andComplain:^(id obj) {
        if ([obj[@"code"] integerValue] == 1) {
            NSDictionary *infoDic = obj[@"data"];
           
            shouhuoInfo = [UserInfo mj_objectWithKeyValues:infoDic];
            if (shouhuoInfo.take_province) {
                [shoujianxinxi setTitle:shouhuoInfo.take_pcc forState:UIControlStateNormal];
                shoujihao.text = shouhuoInfo.take_phone;
            } 
        }
    } andError:nil];
}
-(void)initCommonData{
    self.automaticallyAdjustsScrollViewInsets = NO;
    [self initStation];
    
    [self.stationArr enumerateObjectsUsingBlock:^(TrainStation * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
        if ([obj.name isEqualToString:@"北京"]) {
            chufadiSt = obj;
        } 
        if ([obj.name isEqualToString:@"上海"]) {
            mudidiSt = obj;
        } 
    }];
    self.xiayibu.superview.backgroundColor = [UIColor clearColor];
    [self.xiayibu setTitle:@"下一步(选座)" forState:UIControlStateNormal];
    
    
    [self setStaionTtile];
    self.chengkeView.height = 0;
    [self updateChengkeView];
    if (self.from==4 || self.from == 5) {
        
//        [self initPayView];
        [self.xiayibu setTitle:@"立即下单" forState:UIControlStateNormal];
        
        [self.xiayibu addTarget:self action:@selector(pay) forControlEvents:UIControlEventTouchUpInside];
    }else{
        [self.xiayibu addTarget:self action:@selector(nextStep:) forControlEvents:UIControlEventTouchUpInside];

    }
    

}
#pragma mark - 12306抢票
-(void)init12306QP{
    self.xiayibu.hidden = NO;
    
    qpxinxi = [[NSBundle mainBundle] loadNibNamed:@"qiangpiaoxinxi" owner:self options:nil].firstObject;
    qpxinxi.frame = CGRectMake(0, self.chengkeView.bottom, SWIDTH, 170);
    [self.xiayibu.superview addSubview:qpxinxi];
    shoujihao = [qpxinxi viewWithTag:1];
    zuigaopiaojia = [qpxinxi viewWithTag:2];
    baoxianLable = [qpxinxi viewWithTag:3];
    baoxianLable.text = @"";
    
    self.xiayibu.top = qpxinxi.bottom+20;
    self.xiayibu.centerX =self.view.centerX;
//    shoujihao.text = @"18519554566";
}
#pragma mark - 人工抢票
-(void)initRGQP{
    self.xiayibu.hidden = NO;
    
    qpxinxi = [[NSBundle mainBundle] loadNibNamed:@"qiangpiaoxinxi" owner:self options:nil].firstObject;
    qpxinxi.frame = CGRectMake(0, self.chengkeView.bottom, SWIDTH, 170);
    [self.xiayibu.superview addSubview:qpxinxi];
    shoujihao = [qpxinxi viewWithTag:1];
    zuigaopiaojia = [qpxinxi viewWithTag:2];
    baoxianLable = [qpxinxi viewWithTag:3];
    baoxianLable.text = @"";
    psxinxi = [[NSBundle mainBundle] loadNibNamed:@"qiangpiaoxinxi" owner:self options:nil].lastObject;
    psxinxi.frame = CGRectMake(0, qpxinxi.bottom, SWIDTH, 120);
    [self.xiayibu.superview addSubview:psxinxi];
    
    qupiaofangshi = [psxinxi viewWithTag:1];
    shoujianxinxi = [psxinxi viewWithTag:2];
    [qupiaofangshi addTarget:self action:@selector(qupiaoAct:) forControlEvents:UIControlEventTouchUpInside];
    [shoujianxinxi addTarget:self action:@selector(shoujianxinxiAct:) forControlEvents:UIControlEventTouchUpInside];
//    shoujihao.text = @"18519554566";
    self.xiayibu.top = psxinxi.bottom+20;
    self.xiayibu.centerX =self.view.centerX;


}
-(void)qupiaoAct:(UIButton *)btn{
    NSArray *arr = @[@"快递到家",@"火车站配送"];
    CBAlertView *view = [[CBAlertView alloc]initWithTitle:@"请选取取票方式" actionsTitles:arr imgnames:nil showCancel:YES showSure:NO event:^(id value) {
        [btn setTitle:arr[[value integerValue]] forState:UIControlStateNormal];
        
        
    }];

}
-(void)shoujianxinxiAct:(UIButton *)btn{
    ChangyongPsvc *vc = (ChangyongPsvc *)[self getVCInBoard:@"Main" ID:@"ChangyongPsvc"];
    vc.isfromChoose = YES;
    
    vc.touchEvent = ^(UserInfo *info){
        shouhuoInfo = info;
        
        NSString *str = [NSString stringWithFormat:@"%@ %@",info.take_uname,info.take_pcc];
        [btn setTitle:str forState:UIControlStateNormal];
        
    };
    PUSH(vc);
}

-(void)initPayView{
   
    payView = [[PayView alloc]initWithFrame:CGRectMake(0, SHEIGHT - 45, SWIDTH, 45)];
    payView.clipsToBounds = YES;
    [payView.moneyBtn addTarget:self action:@selector(changeHeight) forControlEvents:UIControlEventTouchUpInside];
    [payView.payBtn addTarget:self action:@selector(pay) forControlEvents:UIControlEventTouchUpInside];

    [self.view addSubview:payView];
    
    NSLog(@"");
}
-(void)changeHeight{
//    126  214
    [UIView animateWithDuration:0.5 animations:^{
        
    if (payView.height==45) {
        payView.height = 45*3;
        payView.top = SHEIGHT - payView.height;
    }else{
        payView.height = 45;
        payView.top = SHEIGHT - payView.height;

    }
    }];
}
-(void)updateChengkeView{
    CGFloat height = selectedCustomer.count*50;
    self.chengkeView.height = height;
    NSInteger index= 100 ;
    for (Customer *cus in selectedCustomer) {
        UIView *view = [self.chengkeView viewWithTag:index];
        UILabel *l1 = [view viewWithTag:10];
        l1.text = cus.name;
        UILabel *l2 = [view viewWithTag:11];
        l2.text = cus.type_name;
        UILabel *l3 = [view viewWithTag:12];
        l3.text = cus.id_number;

        
        
        
        index+=1;
    }
    
    CGFloat hh = self.chengkeView.bottom + 100;

    self.xiayibu.top = self.chengkeView.bottom+30;
    if (qpxinxi) {
        qpxinxi.top = self.chengkeView.bottom;
        hh = qpxinxi.bottom + 100;
    }
    if (psxinxi) {
        psxinxi.top = qpxinxi.bottom;
        hh = psxinxi.bottom + 100;

    }
    
    self.xiayibu.top = hh - 70;
    self.xiayibu.centerX =self.view.centerX;
    if (hh<=SHEIGHT) {
        hh=SHEIGHT+1;
    }
    self.bgScView.contentSize = CGSizeMake(SWIDTH, hh);
}
- (void)showDate {
    NSMutableString *str = [NSMutableString string];
    DateObject *oobj = selectedDate.firstObject;
    train_date = oobj.originalStr;
    
    for (DateObject *date in selectedDate) {
        
        [str appendFormat:@"%@,",date.originalStr];
    }
    [self.riqiBtn setTitle:str forState:UIControlStateNormal];
    
}
-(void)showSeattype{
    NSMutableString *str = [NSMutableString string];

    for (SeatType *type in selectedType) {
        
        [str appendFormat:@"%@,",type.name];
    }
    [self.leixing setTitle:str forState:UIControlStateNormal];
    
    CGFloat maxP = [self getMaxPrice];
    zuigaopiaojia.text = [NSString stringWithFormat:@"¥%.1f",maxP];
    zuigaopiaojia.textColor = [UIColor redColor];
    
    
    
    CGFloat buyedPrice = [self getMaxPrice];
    CGFloat singleIns = 0.0;
    
    if (baoxianInfo) {
        for (NSDictionary *ins in baoxianInfo) {
            if (ins[@"insurance_type"] && [ins[@"insurance_type"] integerValue]==4) {
                CGFloat min = [ins[@"min_val"] floatValue];
                CGFloat max = [ins[@"max_val"] floatValue];
                if (buyedPrice<max && buyedPrice>min) {
                    singleIns = [ins[@"money"] floatValue];
                    break;
                }
            }
        }
    }
    if (singleIns<50) {
        singleIns = singleIns*100;
    }
    NSInteger count = selectedCustomer.count;
    if (count==0) {
        count = 1;
    }
    baoxianLable.text = [NSString stringWithFormat:@"%.1f元/份",singleIns/100.0];
    baoxianPrice = singleIns/100.0;
    payView.baoxianPrice.text =  [NSString stringWithFormat:@"¥%.1f元x%ld",singleIns/100.0,count];
    payView.chepiaoPrice.text = [NSString stringWithFormat:@"¥%.1f元x%ld",buyedPrice,count];
    CGFloat totalprice = singleIns/100.0*count+buyedPrice*count;
    [payView.moneyBtn setTitle:[NSString stringWithFormat:@"实付款:¥%.1f元",totalprice] forState:UIControlStateNormal];
    
}
-(void)showCheci{
    NSMutableString *str = [NSMutableString string];
    
    for (CheCiRes *checi in selectedCheci) {
        
        [str appendFormat:@"%@ ,",checi.train_code];
    }
    [self.checiBtn setTitle:str forState:UIControlStateNormal];
}
- (IBAction)mudidi:(UIButton *)sender {
    BaseViewController *vc = (BaseViewController *)[self getVCInBoard:nil ID:@"ChoeseStationVC"];
    vc.touchEvent = ^(id value){
        TrainStation *st = value;
        mudidiSt = st;
        
        [sender setTitle:st.name forState:UIControlStateNormal];
        NSLog(@"选择了:%@",st.name);
    };
    PUSH(vc);
}
- (IBAction)chufaact:(UIButton *)sender {
    BaseViewController *vc = (BaseViewController *)[self getVCInBoard:nil ID:@"ChoeseStationVC"];
    vc.touchEvent = ^(id value){
        TrainStation *st = value;
        chufadiSt = st;
        
        [sender setTitle:st.name forState:UIControlStateNormal];
        NSLog(@"选择了:%@",st.name);
    };
    PUSH(vc);
}
-(void)setStaionTtile{
    [_chufadi setTitle:chufadiSt.name forState:UIControlStateNormal];
    [_mudidi setTitle:mudidiSt.name forState:UIControlStateNormal];
}
- (IBAction)qiehuan:(UIButton *)sender {
    TrainStation *st = chufadiSt;
    chufadiSt = mudidiSt;
    mudidiSt = st;
    [self setStaionTtile];
   
}
- (IBAction)riqi:(UIButton *)sender {
    ChooseDateViewController *vc = (ChooseDateViewController *)[self getVCInBoard:nil ID:@"ChooseDateViewController"];
    vc.preObjvalue = selectedDate; 
    vc.issingle = self.issingle;
    
    __weak typeof(self) weakSelf = self;
    vc.touchEvent = ^(id value){
        if ([value isKindOfClass:[NSArray class]]) {
            selectedDate = value;
            [weakSelf showDate];
        }  
    };

    PUSH(vc);
}
#pragma mark - 选择车次
- (IBAction)checi:(UIButton *)sender {
    if (selectedDate.count<1 && !_issingle) {
        [LoadingView showAMessage:@"请选择乘车时间"];
        return;
    }


    SearchResVc *vc = (SearchResVc *)[self getVCInBoard:nil ID:@"SearchResVc"];
    __weak typeof(self) weakSelf = self;
    vc.isFromDZ = YES;
    if (!train_date) {
        train_date = [AppManager getCurrentTimeStrWithformat:@"yyyy-MM-dd"];
    }

    BOOL isgtdc = [self.title isEqualToString:@"高铁动车选座"]?1:0;
    vc.preObjvalue = @[chufadiSt,mudidiSt,train_date,@(isgtdc),@0];
    vc.issingle = self.issingle;
    if (self.from == 1 || self.from == 2 || self.from == 3) {
        
        if (!isgtdc) {
            vc.isputong = YES;
        }
    }
    if (self.from==4) {
        vc.issingle = NO;
        vc.isputong = NO;
        
    }
    if (self.from==5) {
        vc.isputong = NO;
        
        vc.issingle = YES;
    }
    vc.touchEvent = ^(id value){
        if ([value isKindOfClass:[NSArray class]]) {
            selectedCheci = value;
            if (self.issingle) {
                CheCiRes *che = selectedCheci.firstObject;
                DateObject *dateObj = [[DateObject alloc]init];
                NSMutableString *ss = [NSMutableString stringWithString:che.train_start_date];
                [ss insertString:@"-" atIndex:4];
                [ss insertString:@"-" atIndex:7];

                dateObj.showStr = ss;
                dateObj.originalStr = ss;
                [selectedDate removeAllObjects];
                [selectedDate addObject:dateObj];
                train_date = selectedDate.firstObject.originalStr;
                
                [weakSelf showDate];
                
            }
            [weakSelf showCheci];
        }  
    };
    
    PUSH(vc);
}
- (IBAction)leixing:(UIButton *)sender {
    if (selectedDate.count<1) {
        [LoadingView showAMessage:@"请选择乘车时间"];
        return;
    }
    if (selectedCheci.count<1) {
        [LoadingView showAMessage:@"请选择车次"];
        return;
    }


    
    ChooseSeatTypeVc *vc = (ChooseSeatTypeVc *)[self getVCInBoard:nil ID:@"ChooseSeatTypeVc"];
    vc.preObjvalue = selectedType;
    vc.issingle = self.issingle;
    if (self.from==5) {
        vc.issingle = NO;
    }
    NSMutableArray *allhaveTypeArr = [NSMutableArray array];
    for (CheCiRes *res  in selectedCheci) {
        for (NSString *strr in res.seatTypeArr) {
            if (![allhaveTypeArr containsObject:strr]) {
                [allhaveTypeArr addObject:strr];
            }
        }
    }
    vc.haveTypeArr = allhaveTypeArr;
    __weak typeof(self) weakSelf = self;
    vc.touchEvent = ^(id value){
        if ([value isKindOfClass:[NSArray class]]) {
            selectedType = value;
            [weakSelf showSeattype];
        }  
    };
    PUSH(vc);
}
- (IBAction)tianjiack:(UIButton *)sender {
    BOOL isLogin = [[NSUserDefaults standardUserDefaults]boolForKey:@"isrxlogin"];
    if (!isLogin) {
        
        BaseViewController *vcv = (BaseViewController *)[AppManager getVCInBoard:nil ID:@"LoginVc"];
        
        vcv.preObjvalue = @"DZXZVc";
        PUSH(vcv);
        return;
    }
    
    
    
    ChoosePerson *vc = (ChoosePerson *)[self getVCInBoard:nil ID:@"ChoosePerson"];
    vc.preObjvalue = selectedCustomer;
    if ([self.title containsString:@"12306"]) {
        vc.ischoose12306 = YES;
    }else{
        vc.ischooserx = YES;
    }
    __weak typeof(self) weakSelf = self;
    vc.touchEvent = ^(id value){
        if ([value isKindOfClass:[NSArray class]]) {
            
            [selectedCustomer removeAllObjects];
            [selectedCustomer addObjectsFromArray:value];
            
            [self showSeattype];
            
            [weakSelf updateChengkeView];
        }  
    };
    PUSH(vc);
}


- (IBAction)delete:(UIButton *)sender {
    NSInteger index = sender.superview.tag - 100;
    if (index<selectedCustomer.count) {
        [selectedCustomer removeObjectAtIndex:index];
        [self updateChengkeView];
    }
}
-(void)nextStep:(UIButton *)btn{
    //测试

    
    
    if (!chufadiSt) {
        return;
    }
    if (!mudidiSt) {
        return;
    }
    if (selectedDate.count<1) {
        [LoadingView showAMessage:@"请选择乘车时间"];
        return;
    }
    if (selectedCheci.count<1) {
        [LoadingView showAMessage:@"请选择车次"];
        return;
    }

    if (selectedType.count<1) {
        [LoadingView showAMessage:@"请选择坐席类型"];
        return;
    }
    if (selectedCustomer.count<1) {
//        [LoadingView showAMessage:@"请选择乘客"];
//        return;
    }
    
    if ([btn.currentTitle isEqualToString:@"下一步(选座)"]) {
       
        SubmitOrderVc *vc = (SubmitOrderVc *)[self getVCInBoard:nil ID:@"SubmitOrderVc"];
        vc.title = @"选择座位";
        
        vc.issirendingzhi = YES;
        
        if (![self.preObjvalue isKindOfClass:[CheCiRes class]]) {
            self.preObjvalue = selectedCheci.firstObject;
        }
        vc.preObjvalue = selectedCheci.firstObject;
        vc.selectedCustomer = selectedCustomer;
        if (self.from==6) {
            vc.isspsm = YES;
        }else if(self.from==7){
            vc.issirendingzhi = YES;
        }
        
            CheCiRes *ress1 = selectedCheci.firstObject;
            NSString *proname = selectedType.firstObject.type_name;
        if (![proname containsString:@"_price"]) {
            
            proname = [proname stringByAppendingString:@"_price"];
        }
            vc.buyedZuowei = selectedType.firstObject.name;
            vc.buyedZuoweiCode = proname;
            vc.buyedPrice = [[ress1 mj_keyValues] objectForKey:proname];
            
            
//        vc.preObjvalue = @[chufadiSt,mudidiSt,train_date,selectedCheci.firstObject,selectedType.firstObject,selectedCustomer];

        PUSH(vc);
    }
    
}
-(NSString *)zuoweiCodeWithName:(NSString *)name{
    //        坐席类型CODE,9:商务座，P:特等座，M:一等座，O:二等座，6:高级软卧，4:软卧，3:硬卧，2:软座，1:硬座
    
    NSString *code = @"";
    if ([name isEqualToString:@"商务座"]) {
        code = @"9";
    }else if ([name isEqualToString:@"特等座"]) {
        code = @"P";
    }else if ([name isEqualToString:@"一等座"]) {
        code = @"M";
    }else if ([name isEqualToString:@"二等座"]) {
        code = @"O";
    }else if ([name isEqualToString:@"高级软卧"]) {
        code = @"6";
    }else if ([name isEqualToString:@"软卧"]) {
        code = @"4";
    }else if ([name isEqualToString:@"硬卧"]) {
        code = @"3";
    }else if ([name isEqualToString:@"软座"]) {
        code = @"2";
    }else if ([name isEqualToString:@"硬座"]) {
        code = @"1";
    }
    return code;
}
-(NSArray *)nameWithCode:(NSString *)code{
    NSString *name = @"";
    NSInteger index = 0;
    
    if ([code containsString:@"swz"]) {
        name = @"商务座";
        index = 1;
    }else if ([code containsString:@"tdz"]) {
        name = @"特等座";
        index = 2;
    }else if ([code containsString:@"ydz"]) {
        name = @"一等座";
        index = 3;
    }else if ([code containsString:@"edz"]) {
        name = @"二等座";
        index = 4;
    }else if ([code containsString:@"gjrw"]) {
        name = @"高级软卧";
        index = 5;
    }else if ([code containsString:@"rw"]) {
        name = @"软卧";
        index = 6;
    }else if ([code containsString:@"rz"]) {
        name = @"软座";
        index = 7;
    }else if ([code containsString:@"yw"]) {
        name = @"硬卧";
        index = 8;
    }else if ([code containsString:@"yz"]) {
        name = @"硬座";
        index = 9;
    }else if ([code containsString:@"wz"]) {
        name = @"无座";
        index = 10;
    }else if ([code containsString:@"qtxb"]) {
        name = @"其它席别";
        index = 11;
    }
    
    return @[name,@(index)];
}

-(CGFloat)getMaxPrice{
    NSInteger min = 20;
    SeatType *zuigui;
    for (SeatType *seat in selectedType) {
        NSInteger index = [[self nameWithCode:seat.type_name].lastObject integerValue];
        if (index<min) {
            min = index;
            zuigui = seat;
        }
    }
    NSString *maxStr = @"";
    if ([zuigui.name containsString:@"硬卧"]) {
        maxStr = @"ywx_price";
    }else if ([zuigui.name containsString:@"高级软卧"]) {
        maxStr = @"gjrw_price";
        
    }else if ([zuigui.name containsString:@"软卧"]) {
        maxStr = @"rwx_price";
    }else{
        maxStr = [zuigui.type_name stringByAppendingString:@"_price"];
    }
    CGFloat maxP = 0;
    for (CheCiRes *resche in selectedCheci) {
        NSString *price = [[resche mj_keyValues] objectForKey:maxStr];
        if (price && price.length>0) {
            CGFloat p = [price floatValue];
            if (p>maxP) {
                maxP = p;
            }
        }
    }

    return maxP;
    
    
}

-(void)pay{
    CheCiRes *checi = selectedCheci.firstObject;

    if (!checi) {
        [LoadingView showAMessage:@"请选择车次"];
        
        return;
    }
    if (selectedCustomer.count<1) {
        [LoadingView showAMessage:@"请选择乘客"];
        
        return;
    }
    if (shoujihao.text.length<5) {
        [LoadingView showAMessage:@"请填写手机号"];
        return;
    }
    if (!shouhuoInfo) {
        [LoadingView showAMessage:@"请填写收件信息"];
        
        return;
    }
    
    
    
    NSMutableDictionary *par = [NSMutableDictionary dictionary];
    par[@"UToken"] = UToken;
    
    par[@"from_station_code"] = checi.from_station_code;
    par[@"from_station_name"] = checi.from_station_name;
    par[@"to_station_code"] = checi.to_station_code;
    par[@"to_station_name"] = checi.to_station_name;
    

    NSString *postUrl = @"Action/createGrabTicketOnline/";
    
    if (self.from==4) {
        
        NSString *LoginUserName = [[NSUserDefaults standardUserDefaults] objectForKey:@"zh12306"];
        NSString *LoginUserPassword = [[NSUserDefaults standardUserDefaults] objectForKey:@"mm12306"];
        
        par[@"LoginUserName"] = LoginUserName;
        par[@"LoginUserPassword"] = LoginUserPassword;
        
        NSString *trainType = [checi.train_code substringToIndex:1];
        //    	G,D,Z,T,K,C,Q	
        if ([trainType isEqualToString:@"G"] || [trainType isEqualToString:@"D"] || [trainType isEqualToString:@"Z"]|| [trainType isEqualToString:@"T"]|| [trainType isEqualToString:@"K"]|| [trainType isEqualToString:@"C"]) {
            
            par[@"train_type"] = trainType; 
        }else{
            par[@"train_type"] = @"Q"; 
        }
        NSString *start_date = @"";
        
        for (int i=0; i<selectedDate.count; i++) {
            NSString *dd = selectedDate[i].originalStr;
            dd = [dd stringByReplacingOccurrencesOfString:@"-" withString:@""];
            dd = [dd stringByReplacingOccurrencesOfString:@"-" withString:@""];
            dd = [dd stringByAppendingString:@","];
            start_date = [start_date stringByAppendingString:dd];            
        }
        par[@"start_date"] = start_date;

        par[@"start_begin_time"] = @"00:00";
        par[@"start_end_time"] = @"24:00";
        
        NSString *train_codes = @"";
        for (CheCiRes *re  in selectedCheci) {
            NSString *tt = [re.train_code stringByAppendingString:@","];
            train_codes = [train_codes stringByAppendingString:tt];
            
        }
//        坐席类型CODE,9:商务座，P:特等座，M:一等座，O:二等座，6:高级软卧，4:软卧，3:硬卧，2:软座，1:硬座
        par[@"train_codes"] = train_codes;
        par[@"seat_type"] = [_leixing.currentTitle stringByReplacingOccurrencesOfString:@"无座" withString:@"其他"];
        par[@"qorder_start_time"] = [AppManager getCurrentTimeStrWithformat:@"yyyy-MM-dd HH:mm:ss"];
        NSDate *end = [NSDate dateWithTimeIntervalSinceNow:3600*24*60];
        
        par[@"qorder_start_time"] = [selectedDate.firstObject.originalStr stringByAppendingString:@" 00:00:01"];
        par[@"qorder_end_time"] = [AppManager stringFromDate:end format:@"yyyy-MM-dd HH:mm:ss"];
        

        
        CGFloat buyedPrice = [self getMaxPrice];
        par[@"max_price"] = @(buyedPrice);
        
        NSMutableArray *passengers = [NSMutableArray array];
        
        //        票类型;1:成人票，2:儿童票，3:学生票，4:残军票

        for (Customer *cus in selectedCustomer) {
            NSDictionary *passeng = @{@"passengersename":cus.name,@"passportseno":cus.id_number?cus.id_number:@"",@"passporttypeseidname":cus.id_name?cus.id_name:@"身份证",@"passporttypeseid":@(cus.id_type),@"passengerid":cus.passengerid,@"piaotype":@"1"};
            NSMutableDictionary *dicc = [NSMutableDictionary dictionaryWithDictionary:passeng];
            //当是学生时需要更多信息
            if (cus.isXs) {
                
            }
            [passengers addObject:dicc];
        }
        CGFloat singleIns = 0.0;
        
        if (baoxianInfo) {
            for (NSDictionary *ins in baoxianInfo) {
                if (ins[@"insurance_type"] && [ins[@"insurance_type"] integerValue]==2) {
                    CGFloat min = [ins[@"min_val"] floatValue];
                    CGFloat max = [ins[@"max_val"] floatValue];
                    if (buyedPrice<max && buyedPrice>min) {
                        singleIns = [ins[@"money"] floatValue];
                        break;
                    }
                }
            }
        }
        if (singleIns<50) {
            singleIns = singleIns*100;
        }
        
        par[@"insurance"] = [NSString stringWithFormat:@"%.0f",singleIns];
        par[@"all_insurance"] = [NSString stringWithFormat:@"%.0f",singleIns*passengers.count];
        
        
        
        par[@"passengers"] = passengers;
        
    }else {
        
        postUrl = @"Action/createGrabTicketOffline/";
        
        par[@"checi"] = checi.train_code;
        par[@"runtime"] = checi.run_time;
        NSMutableString *ss = [NSMutableString stringWithString:checi.train_start_date];
        [ss insertString:@"-" atIndex:4];
        [ss insertString:@"-" atIndex:7];
        
        par[@"train_date"] = ss;
        par[@"start_time"] = [NSString stringWithFormat:@"%@ %@:00" ,ss,checi.start_time];
        
        par[@"arrive_time"] = [NSString stringWithFormat:@"%@ %@:00" ,ss,checi.arrive_time];
        
        
        NSMutableArray *zwcodearr = [NSMutableArray array];
        for (SeatType *seat in selectedType) {
            NSString *code = [self zuoweiCodeWithName:seat.name];
            [zwcodearr addObject:code];
        }
        par[@"zwcodearr"] = zwcodearr;
        
        
        
//        par[@"prompt_message"] = _zxddField.text;
        
        
        par[@"take_uname"] = @"张三";
        par[@"take_phone"] = shoujihao.text;
        
        par[@"sendtype"] = @"2";
        NSInteger sendtype = 2;
        if ([qupiaofangshi.currentTitle isEqualToString:@"快递到家"]) {
            par[@"sendtype"] = @"1";
            sendtype = 1;
            
        }
        if (sendtype==1) {
            if (!shouhuoInfo) {
                [LoadingView showAMessage:@"请选择收件信息"];
                return;
            }
            par[@"take_province"] = shouhuoInfo.take_province;
            par[@"take_city"] = shouhuoInfo.take_city;
            par[@"take_county"] = shouhuoInfo.take_county;
            par[@"take_address"] = shouhuoInfo.take_address;
        }
        
        
        CGFloat buyedPrice = [self getMaxPrice];
        
        par[@"max_price"] = @(buyedPrice);
        
        //乘客信息
        NSMutableArray *passengers = [NSMutableArray array];
        for (Customer *cus in selectedCustomer) {

            cus.passengerid = cus.person_id;
            
            NSDictionary *passeng = @{@"contacts_id":cus.passengerid,@"piaotype":@1,@"cxin":@""};
            
            [passengers addObject:passeng];
        }
        par[@"passengers"] = passengers;

        CGFloat singleIns = 0.0;
        
        if (baoxianInfo) {
            for (NSDictionary *ins in baoxianInfo) {
                if (ins[@"insurance_type"] && [ins[@"insurance_type"] integerValue]==4) {
                    CGFloat min = [ins[@"min_val"] floatValue];
                    CGFloat max = [ins[@"max_val"] floatValue];
                    if (buyedPrice<max && buyedPrice>min) {
                        singleIns = [ins[@"money"] floatValue];
                        break;
                    }
                }
            }
        }
        if (singleIns<50) {
            singleIns = singleIns*100;
        }
        
        par[@"insurance"] = [NSString stringWithFormat:@"%.0f",singleIns];
        par[@"all_insurance"] = [NSString stringWithFormat:@"%.0f",singleIns*passengers.count];
        
        
        
        
    }
    
    
    
    
    
    [[Httprequest shareRequest] postObjectByParameters:[self getparametersWithDic:par] andUrl:postUrl showLoading:YES showMsg:YES isFullUrk:NO andComplain:^(id obj) {
        if ([obj[@"code"] integerValue] == 1) {
            //                [self.navigationController popToRootViewControllerAnimated:YES];
            NSString *orderid = obj[@"data"][@"orderid"];
            if (!orderid) {
                [LoadingView showAMessage:obj[@"data"][@"result"]];
                
                return ;
            }
            OrderDetailAndPay *vc = (OrderDetailAndPay *)[self getVCInBoard:nil ID:@"OrderDetailAndPay"];
            
            vc.orderid = orderid;
            vc.url = self.from==4?@"Action/grabRowOnline/":@"Action/grabRowOffline/";
            vc.tuipiaoUrl = self.from==4?@"Action/grabOnlineReturn/":@"Action/grabOfflineReturn/";
     
            
            PUSH(vc);
        }
    } andError:^(id error) {
        
    }];   
    
}
@end
