//
//  SearchResVc.m
//  CommonProject
//
//  Created by mac on 2017/1/6.
//  Copyright © 2017年 mac. All rights reserved.
//

#import "SearchResVc.h"
#import "NSString+Hash.h"
#import "CocoaSecurity.h"
#import "NSString+Encryption.h"
#import "RSA.h"
#import "HZQDatePickerView.h"
#import "SelectTimeView.h"
#import "CalenderView.h"

@implementation ResultCell



@end

@interface SearchResVc ()
{
    TrainStation *st1;
    TrainStation *st2;
    HZQDatePickerView *_pikerView;
    NSString *train_date;
    UIButton *shaixuanView;
    BOOL gt;
    BOOL dc;
    BOOL pt;
    BOOL qt;
    NSString *startTime;
    NSString *endTime;
    NSString *tmpstartTime;
    NSString *tmpendTime;
    BOOL showPrice;
    NSMutableArray *originalDataSource;
    NSMutableArray *selectDatas;
    NSInteger isgtdc;
    NSInteger cur_chose_time;
    UIButton *suresxBtn;
    UIView *shadeView;
    
}
@end

@implementation SearchResVc

- (void)viewDidLoad {
    [super viewDidLoad];
    UIView *view = [[UIView alloc]initWithFrame:self.view.frame];
    
    view.backgroundColor = [[UIColor blackColor] colorWithAlphaComponent:0.3];
    view.hidden = YES;
    view.top = 64;
    shadeView = view;
    
    [self.view addSubview:view];
    
    
    self.navBar.hidden = YES;
    self.mainTableView.backgroundColor = BgWhiteColor;
    NSArray *arr = self.preObjvalue;
    self.bglightV.hidden = YES;
    [self.bglightV.superview sendSubviewToBack:self.bglightV];
    selectDatas = [NSMutableArray array];
    @try {
        st1 = arr[0];
        st2 = arr[1];
        train_date = arr[2];
        isgtdc = [arr[3] integerValue];

    } @catch (NSException *exception) {
        
    } @finally {
        
    }
    //    NSInteger xsp = [arr[4] integerValue];
    
    [self.chufadi setText:st1.name];
    [self.mudidi setText:st2.name];
    
    
    NSString *str = [train_date stringByReplacingOccurrencesOfString:@"-" withString:@"年"];
    str = [str stringByReplacingOccurrencesOfString:@"-" withString:@"月"];
    str = [str stringByAppendingString:@"日"];
    [self.dateBtn setTitle:str forState:UIControlStateNormal];
    __weak typeof(self) weakSelf = self;
    self.mainTableView.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^{
        [weakSelf loadNetData2];
        
    }];
    [self loadNetData2];
    tmpstartTime = @"00:00";
    tmpendTime = @"24:00";
    NSDate *date = [AppManager dateFromString:train_date format:@"yyyy-MM-dd"] ;
    
    cur_chose_time = [date timeIntervalSince1970];
    NSLog(@"");
    
}
-(void)loadNetData2{
    NSMutableDictionary *parameters = [NSMutableDictionary dictionary];
    NSString *key = @"AwCT4ccslMB3TFQ6M8H6qadrOT8ZCXVg";
    parameters[@"partnerid"] = @"bjrwx";
    parameters[@"reqtime"] = [AppManager getCurrentTimeStrWithformat:@"yyyyMMddHHmmss"];//yyyyMMddHHmmss
    NSString *md5Key = [key md5Hash];
    NSLog(@"md5Key   %@",md5Key);
    parameters[@"method"] = @"train_query";
    
    NSString *sign = [NSString stringWithFormat:@"%@%@%@%@",parameters[@"partnerid"],parameters[@"method"],parameters[@"reqtime"],md5Key];
    NSLog(@"sign   %@",sign);
    parameters[@"sign"] = [sign md5Hash];//md5(partnerid+method+reqtime+md5(key))
    
    
    
    parameters[@"train_date"] = train_date;//yyyy-MM-dd
    
    parameters[@"from_station"] = st1.szm;
    parameters[@"to_station"] = st2.szm;
    
    parameters[@"purpose_codes"] = @"ADULT";
    
    //post
    NSString *posturl = [NSString stringWithFormat:@"http://searchtrain.hangtian123.net/trainSearch"];
    
    NSDictionary *postPar = @{@"jsonStr":[parameters mj_JSONString]};
    shadeView.hidden = NO;
    
    [[Httprequest shareRequest] postObjectByParameters:postPar andUrl:posturl showLoading:YES showMsg:YES isFullUrk:YES andComplain:^(id obj) {
        NSLog(@"");
        NSArray *arr= obj[@"data"];
        shadeView.hidden = YES;

        if ([self.mainTableView.mj_header isRefreshing]) {
            [self.mainTableView.mj_header endRefreshing];
            
        }
        if ([self.mainTableView.mj_footer isRefreshing]) {
            [self.mainTableView.mj_footer endRefreshing];
            
        }
        
        self.mainDataSource = [CheCiRes mj_objectArrayWithKeyValuesArray:arr];
        NSString *tdtime = [AppManager getCurrentTimeStrWithformat:@"yyyy-MM-dd"];
        for (int i=0; i<self.mainDataSource.count;i++) {
            CheCiRes *res  = self.mainDataSource[i];
            res.train_start_date = [train_date stringByReplacingOccurrencesOfString:@"-" withString:@""];
            
            
        }
        if ([tdtime isEqualToString:train_date]) {
            NSString *time = [AppManager getCurrentTimeStrWithformat:@"HH:mm"];
            NSInteger minute = [self solveMinuteWithTime:time];
            //过滤一小时内的车次
            NSInteger count = 60;
            for (int i=0; i<self.mainDataSource.count;) {
                CheCiRes *res  = self.mainDataSource[i];
//  
                NSInteger sttime = [self solveMinuteWithTime:res.start_time];
                if (sttime-minute<count) {
                    [self.mainDataSource removeObject:res];
                    
                }else{
                    i++;
                }
            }

        }
        originalDataSource = self.mainDataSource;
         [self.mainTableView reloadData];
        
        
        if (isgtdc && !_isputong) {
            
            [self shaixuan:nil];
            [self sureShaixuan:suresxBtn];
            [shaixuanView removeFromSuperview];
            shaixuanView = nil;
        }else if (_isputong){
            [self shaixuan:nil];
            [self sureShaixuan:suresxBtn];
            [shaixuanView removeFromSuperview];
            shaixuanView = nil;
        }
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            [self.mainTableView reloadData];
            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
                [self.mainTableView reloadData];
            });
        });
    } andError:^(id error) {
        shadeView.hidden = YES;

    }];
    
    
    
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    if (self.isFromDZ) {
        CheCiRes *res = self.mainDataSource[indexPath.row];
        if (!res.isChoosed) {
            if (self.issingle) {
                if (selectDatas.count>=1) {
                    [LoadingView showAMessage:@"本次只能选择一个车次"];
                    return;
                }
            }else{
                if (selectDatas.count>=5) {
                    [LoadingView showAMessage:@"本次只能选择5个车次"];
                    return;
                }
            }
        }
        res.isChoosed = !res.isChoosed;
        
        [self.mainTableView reloadData];
        [selectDatas removeAllObjects];
        [self.mainDataSource enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            CheCiRes *res = obj;
            if (res.isChoosed) {
                [selectDatas addObject:res];
            }
        }];
        
        if (self.touchEvent) {
            self.touchEvent(selectDatas);
            
        }
        if (self.issingle) {
            POP;
        }
        return;
    }
    CheCiRes *res = self.mainDataSource[indexPath.row];
    BaseViewController *vc = ( BaseViewController *)[self getVCInBoard:nil ID:@"BuyTicketChooeseSeatVc"];
    vc.preObjvalue = res;
    
    PUSH(vc);
    
}
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 1;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return self.mainDataSource.count;
}
-(void)tableView:(UITableView *)tableView willDisplayCell:(ResultCell  *)cell forRowAtIndexPath:(NSIndexPath *)indexPath{
    cell.backgroundColor = [UIColor clearColor];
    cell.contentView.backgroundColor = [UIColor clearColor];
    CheCiRes *res = self.mainDataSource[indexPath.row];
    cell.chufadi.text = res.from_station_name;
    cell.mudidi.text = res.to_station_name;
    
    cell.lishi.text = [NSString stringWithFormat:@"%@分",[res.run_time stringByReplacingOccurrencesOfString:@":" withString:@"时"] ];
    
    cell.chufashijian.text = res.start_time;
    cell.daodashijian.text = res.arrive_time;
    cell.checi.text = res.train_code;
    cell.yuyueBtn.hidden = YES;
    cell.jiage.text = [NSString stringWithFormat:@"¥%.1f起", [[self getMinPrice:res] floatValue]];
    cell.jiage.font = Font(16);
    cell.jiage.minimumScaleFactor = 0.5;
    if (self.isFromDZ) {
        cell.chooseBtn.hidden = NO;
    }else{
        cell.chooseBtn.hidden = YES;
        cell.chufadi.left = 12;
        cell.chufashijian.left = 12;
    }
    cell.chooseBtn.selected = res.isChoosed;
    
    cell.chooseBtn.userInteractionEnabled = NO;
    
    //设置中间指示图片
    if ([res.start_station_name isEqualToString:res.from_station_name]) {
        if ([res.end_station_name isEqualToString:res.to_station_name]) {
            cell.indicatorView.image = [UIImage imageNamed:@"qi-zhong"];
        }else{
            cell.indicatorView.image = [UIImage imageNamed:@"qi-zhuan"];
            
        }
    }else{
        if ([res.end_station_name isEqualToString:res.to_station_name]) {
            cell.indicatorView.image = [UIImage imageNamed:@"zhuan-zhong"];
        }else{
            cell.indicatorView.image = [UIImage imageNamed:@"zhuan-zhuan"];
            
        }
    }
    
    //    设置显示张数和票价
    
    NSArray *arr =  [self getZuowei:res];
    NSMutableArray *searTypeArr = [NSMutableArray array];
    for (NSString *ss  in arr) {
        [searTypeArr addObject:[ss componentsSeparatedByString:@":"].firstObject];
    }
    res.seatTypeArr = searTypeArr;
    
    UIView *superv = cell.zuowei1.superview;
    CGFloat w  = SWIDTH -16- (arr.count+1)*5;
    
    CGFloat ww = w/arr.count;
    for (UIView *v in superv.subviews) {
        if ([v isKindOfClass:[UIImageView class]]) {
            
        }else{
            v.centerY = v.superview.height*0.5;
            v.hidden = YES;
            
        }

    }
    if (res.note && [res.note containsString:@"未到预售期"]) {
        cell.shuoming.text = res.note;
        cell.shuoming.hidden = NO;
        cell.yuyueBtn.hidden = NO;
        [cell.yuyueBtn setTitle:@"预约" forState:UIControlStateNormal];
        return  ;
        
    }
    NSInteger index = 1;
    for (NSString *price in arr) {
        UILabel *l = [superv viewWithTag:index];
        l.text = price;
        
        l.textColor = [UIColor blackColor];

        l.minimumScaleFactor = 0.7;

        l.left = 5+(ww+5)*(index-1);
        l.textAlignment = NSTextAlignmentCenter;
        l.width = ww;
        CGFloat hhhhhh = 14.0/375*SWIDTH;
        if (hhhhhh>17) {
            hhhhhh = 17;
        }
        l.font =Font(hhhhhh);
        if (SWIDTH==320) {
            l.font = Font(11);
        }
        [l sizeToFit];
        if (l.width>ww-5) {
            l.width = ww-5;
        }
        
        CGFloat centerX = ww*0.5+(5+ww)*(index-1);
   
        l.centerX = centerX;

        if (index==1) {
            l.left = cell.chufadi.left;
        }else if (index==2) {
            l.centerX  = cell.checi.centerX;
        }else if (index==3) {
            l.right = cell.mudidi.right;
        }else if (index==4) {
            l.right = cell.jiage.right;
        }
        if ([price containsString:@":0张"]) {
            
            UILabel *qiang = [superv viewWithTag:index+10-1];
            qiang.hidden = NO;
            l.width-=5;
            qiang.left = l.right;
            qiang.top = l.top-5;
            qiang.layer.cornerRadius = 7.5;
            qiang.layer.masksToBounds = YES;
        }
        l.hidden = NO;
       
        index+=1;
    }
    BOOL iszero = YES;
    for (NSString *price in arr) {
        if (![price containsString:@":0张"]) {
            iszero = NO;
            break;
        }
    }
    if (iszero) {
        [cell.yuyueBtn setTitle:@"去抢票" forState:UIControlStateNormal];
        cell.yuyueBtn.titleLabel.font = [UIFont systemFontOfSize:14];
        cell.yuyueBtn.hidden = NO;
        cell.yuyueBtn.userInteractionEnabled = NO;
    }
    
    

}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    static NSString *resue = @"searchres";
    ResultCell *cell = [tableView dequeueReusableCellWithIdentifier:resue];
    if (!cell) {
        cell = [[ResultCell alloc]initWithStyle:UITableViewCellStyleValue1 reuseIdentifier:resue];
    }
       
    
    return cell;
}
-(NSString *)getMinPrice:(CheCiRes *)res{
    NSString *place = @"--";
    NSDictionary *dicc = [res mj_keyValues];
    NSMutableArray *keys = [NSMutableArray array];
    for (NSString *key in dicc.allKeys) {
        if ([key containsString:@"_num"] && ![dicc[key] isEqualToString:place]) {
            NSString *newk = [key stringByReplacingOccurrencesOfString:@"_num" withString:@"_price"];
            [keys addObject:dicc[newk]];
        }
    }
    [keys sortUsingComparator:^NSComparisonResult(id  _Nonnull obj1, id  _Nonnull obj2) {
        
        return [obj1 floatValue]<[obj2 floatValue];
    }];
    
    return keys.lastObject;
}
-(NSArray *)getZuowei:(CheCiRes *)res{
    NSString *place = @"--";
    NSDictionary *dicc = [res mj_keyValues];
    NSMutableArray *keys = [NSMutableArray array];
    for (NSString *key in dicc.allKeys) {
        if ([key containsString:@"_num"] && ![dicc[key] isEqualToString:place]) {
            [keys addObject:key];
        }
    }
    
    NSMutableArray <NSString *>*arr = [NSMutableArray array];
    for (NSString *kkkk in keys) {
        //        NSString *numkey = [kkkk stringByReplacingOccurrencesOfString:@"num" withString:@"price"];
        NSArray *aa = [self nameWithCode:kkkk];
        NSInteger index = [aa.lastObject integerValue];
        
        NSString *info = [NSString stringWithFormat:@"%02ld%@:%@张",index,aa[0],dicc[kkkk]];
        if (showPrice) {
            NSString *pricekey = [kkkk stringByReplacingOccurrencesOfString:@"num" withString:@"price"];
            info = [NSString stringWithFormat:@"%02ld%@:¥%@",index,aa[0],dicc[pricekey]];
        }
        
        [arr addObject:info];
    }
    [arr sortUsingComparator:^NSComparisonResult(id  _Nonnull obj1, id  _Nonnull obj2) {
        NSString *s1 = obj1;
        NSString *s2 = obj2;
        NSInteger a = [[s1 substringToIndex:2] integerValue];
        NSInteger b = [[s2 substringToIndex:2] integerValue];
        
        return a>b;
    }];
    for (int i=0; i<arr.count; i++) {
        arr[i] = [arr[i] substringFromIndex:2];
    }
    
    if (arr.count>4) {
        [arr removeLastObject];
    }
    if (arr.count>4) {
        [arr removeLastObject];
    }
    if (arr.count>4) {
        [arr removeLastObject];
    }
    return arr;
}
-(NSArray *)nameWithCode:(NSString *)code{
    NSString *name = @"";
    NSInteger index = 0;
    
    if ([code containsString:@"swz"]) {
        name = @"商务座";
        index = 1;
    }else if ([code containsString:@"tdz"]) {
        name = @"特等座";
        index = 2;
    }else if ([code containsString:@"ydz"]) {
        name = @"一等座";
        index = 3;
    }else if ([code containsString:@"edz"]) {
        name = @"二等座";
        index = 4;
    }else if ([code containsString:@"gjrw"]) {
        name = @"高级软卧";
        index = 5;
    }else if ([code containsString:@"rw_"]) {
        name = @"软卧";
        index = 6;
    }else if ([code containsString:@"rz"]) {
        name = @"软座";
        index = 7;
    }else if ([code containsString:@"yw_"]) {
        name = @"硬卧";
        index = 8;
    }else if ([code containsString:@"yz"]) {
        name = @"硬座";
        index = 9;
    }else if ([code containsString:@"wz"]) {
        name = @"无座";
        index = 10;
    }else if ([code containsString:@"qtxb"]) {
        name = @"其它席别";
        index = 11;
    }
    
    return @[name,@(index)];
}
- (IBAction)newxtAction:(UIButton *)sender {
    NSInteger space = 24*60*60;
    
    NSDate *cur = [NSDate date];
    NSString *timstr = [AppManager stringFromDate:cur format:@"yyyy-MM-dd"];
    NSDate *dateee = [AppManager dateFromString:timstr format:@"yyyy-MM-dd"];
    
    NSInteger min = [dateee timeIntervalSince1970];
    NSInteger max = min+space*30;
    if ((cur_chose_time + space)>max) {
        sender.enabled = NO;
    }else{
        _preday.enabled = YES;
        cur_chose_time +=space;
        
    }
    NSDate *newDate = [NSDate dateWithTimeIntervalSince1970:cur_chose_time];
    
    NSString *newStr = [AppManager stringFromDate:newDate format:@"yyyy-MM-dd"];
    train_date = newStr;
    [self dateStrtoYearStr:newStr];    
    [self loadNetData2];
    
}

- (IBAction)backAction:(UIButton *)sender {
    [self.navigationController popViewControllerAnimated:YES];
    
}
- (IBAction)predayAction:(UIButton *)sender {
    NSInteger space = 24*60*60;
    NSDate *cur = [NSDate date];
    NSString *timstr = [AppManager stringFromDate:cur format:@"yyyy-MM-dd"];
    NSDate *dateee = [AppManager dateFromString:timstr format:@"yyyy-MM-dd"];
    
    NSInteger min = [dateee timeIntervalSince1970];
    
    
    if ((cur_chose_time - space)<min) {
        sender.enabled = NO;
    }else{
        _nextBtn.enabled = YES;
        cur_chose_time -=space;
        
    }
    NSDate *newDate = [NSDate dateWithTimeIntervalSince1970:cur_chose_time];
    
    NSString *newStr = [AppManager stringFromDate:newDate format:@"yyyy-MM-dd"];
    train_date = newStr;
    [self dateStrtoYearStr:newStr];
    
    [self loadNetData2];
    
}
- (IBAction)shaixuan:(UIButton *)sender {
    self.bglightV.hidden = YES;
    if (shaixuanView) {
        shaixuanView.hidden = NO;
        [UIView animateWithDuration:0.2 animations:^{
            shaixuanView.alpha = 1.0; 
        }];
    }else
        [self createShaixuanView];
}
- (IBAction)chufatime:(UIButton *)sender {
    self.bglightV.hidden = NO;
    [UIView animateWithDuration:0.2 animations:^{
        self.bglightV.centerX = sender.centerX; 
    }];
    
    [self.mainDataSource sortUsingComparator:^NSComparisonResult(id  _Nonnull obj1, id  _Nonnull obj2) {
        CheCiRes *res1 = obj1;
        CheCiRes *res2 = obj2;
        NSInteger t11 = [[res1.start_time componentsSeparatedByString:@":"].firstObject integerValue]*60+ [[res1.start_time componentsSeparatedByString:@":"].lastObject integerValue];
        
        NSInteger t12 = [[res2.start_time componentsSeparatedByString:@":"].firstObject integerValue]*60+ [[res1.start_time componentsSeparatedByString:@":"].lastObject integerValue];
        
        
        return t11>t12;
        
        
    }];
    [self.mainTableView reloadData];
    
}
- (IBAction)lvxinghaoshi:(UIButton *)sender {
    self.bglightV.hidden = NO;
    [UIView animateWithDuration:0.2 animations:^{
        self.bglightV.centerX = sender.centerX; 
    }];
    [self.mainDataSource sortUsingComparator:^NSComparisonResult(id  _Nonnull obj1, id  _Nonnull obj2) {
        CheCiRes *res1 = obj1;
        CheCiRes *res2 = obj2;
        NSInteger t11 = [res1.run_time_minute integerValue];
        NSInteger t12 = [res2.run_time_minute integerValue];
        
        
        return t11>t12;
        
        
    }];
    [self.mainTableView reloadData];
    
    
}
- (IBAction)xianshipiaojia:(UIButton *)sender {
    self.bglightV.hidden = NO;
    [UIView animateWithDuration:0.2 animations:^{
        self.bglightV.centerX = sender.centerX; 
    }];
    
    if ([sender.currentTitle isEqualToString:@"显示票价"]) {
        [sender setTitle:@"显示余票" forState:UIControlStateNormal];
    }else{
        [sender setTitle:@"显示票价" forState:UIControlStateNormal];
    }
    showPrice = !showPrice;
    [self.mainTableView reloadData];
}

- (IBAction)dateAction:(UIButton *)sender {
//    [self setupDateView:DateTypeOfStart];
    [self showCalendaer];
}
-(void)showCalendaer{
    UIView *view = [[UIView alloc]initWithFrame:self.view.frame];
    view.backgroundColor = [[UIColor blackColor] colorWithAlphaComponent:0.5];
    view.layer.cornerRadius = 1;
    view.layer.masksToBounds = YES;
    [self.view addSubview:view];
    
 
    CalenderView *calender = [[CalenderView alloc]initWithFrame:CGRectMake(30, 50, SWIDTH-60, 400)  andMaxDays:60];
    calender.layer.cornerRadius = 5;
    calender.clipsToBounds = YES;
    calender.height = calender.viewHeight;
    calender.centerY = view.centerY;
    __weak typeof(self) weakSelf = self;
    calender.getDate = ^(NSString *str){
        NSLog(@"%@",str);  
        [weakSelf getSelectDate:str type:1];
        
        [self dateStrtoYearStr:str];
    };
    [view addSubview:calender];
    
    
}
-(void)dateStrtoYearStr:(NSString *)str{
    NSMutableString *tit = [NSMutableString stringWithString:str];
    [tit replaceCharactersInRange:NSMakeRange(4, 1) withString:@"年"];
    [tit replaceCharactersInRange:NSMakeRange(7, 1) withString:@"月"];
    [tit appendString:@"日"];
    [self.dateBtn setTitle:tit forState:UIControlStateNormal];

}
-(void)createShaixuanView{
    shaixuanView = [[UIButton alloc]init];
    
    [shaixuanView addTarget:self action:@selector(cancelAct) forControlEvents:UIControlEventTouchUpInside];
    [[UIApplication sharedApplication].keyWindow addSubview:shaixuanView];
    
    shaixuanView.frame = CGRectMake(0, 0, SWIDTH, SHEIGHT);
    
    shaixuanView.alpha = 0.0;
    [[UIApplication sharedApplication].keyWindow addSubview:shaixuanView];
    [UIView animateWithDuration:0.2 animations:^{
        shaixuanView.alpha = 1.0;
    } completion:^(BOOL finished) {
        
    }];
    
    shaixuanView.backgroundColor = [UIColor colorWithWhite:0.0 alpha:0.4];
    
    
    //    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(cancelAct)];
    //    [shaixuanView addGestureRecognizer:tap];
    
    CGFloat space = 45;
    CGFloat ww = SWIDTH-40;
    CGFloat h = 400;
    
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, ww, h)];
    view.backgroundColor = [UIColor whiteColor];
    view.layer.cornerRadius = 10;
    view.layer.masksToBounds = YES;
    [shaixuanView addSubview:view];
    view.center = shaixuanView.center;
    UILabel *titlelable;
    {
        //titlelable
        UILabel *lable = [[UILabel alloc]initWithFrame:CGRectMake(0, 0, ww, space)];
        lable.textColor = BlueColor;
        lable.textAlignment = NSTextAlignmentCenter;
        lable.text = @"筛选";
        lable.font = [UIFont systemFontOfSize:16];
        [view addSubview:lable];
        
        titlelable = lable;
        
        UIView *view2 = [[UIView alloc]initWithFrame:CGRectMake(0, 43, ww, 0.5)];
        view2.backgroundColor = [UIColor lightGrayColor];
        [view addSubview:view2];
        
        
        
        UIButton *btn = [[UIButton alloc]initWithFrame:CGRectMake(view.width-40, 0, 40, 40)];
        [btn setImage:[UIImage imageNamed:@"guanbi"] forState:UIControlStateNormal];
        [btn addTarget:self action:@selector(cancelAct) forControlEvents:UIControlEventTouchUpInside];
        btn.backgroundColor = [UIColor clearColor];
        
        btn.tag = 1005;
        [view addSubview:btn];
    }
    {
        UILabel *lable1 = [[UILabel alloc]initWithFrame:CGRectMake(10, titlelable.bottom, 120, 30)];
        lable1.textColor = [UIColor lightGrayColor];
        lable1.text = @"车辆类型";
        lable1.font = [UIFont systemFontOfSize:15];
        [view addSubview:lable1];
        
        {
            UILabel *lable = [[UILabel alloc]initWithFrame:CGRectMake(10, lable1.bottom+40, 120, 30)];
            lable.textColor = [UIColor lightGrayColor];
            lable.text = @"乘车时间";
            lable.font = [UIFont systemFontOfSize:15];
            [view addSubview:lable];
        }
        NSArray *titl = @[@"高铁(G/C)",@"动车(D)",@"普通(Z/K/T)",@"其他(L/Y等)"];
        CGFloat btnw = (view.width-20-15)/4.0;
        UIButton *lastBtn ;
        
        for (int i=0; i<4; i++) {
            UIButton *btn = [[UIButton alloc]initWithFrame:CGRectMake(10+(btnw+5)*i, lable1.bottom, btnw, 40)];
            [btn addTarget:self action:@selector(sxbbtnClick:) forControlEvents:UIControlEventTouchUpInside];
            btn.backgroundColor = [UIColor lightGrayColor];
            
            btn.backgroundColor = BlueColor;
            btn.selected = YES;

            if (isgtdc==YES && !_isputong) {
                if ( i<2) {
                    btn.backgroundColor = BlueColor;
                    btn.selected = YES;
                }else {
                    btn.selected = NO;   
                    btn.backgroundColor = [UIColor lightGrayColor];
                }
            }
            if (_isputong) {
                if ( i<2) {
                    btn.selected = NO;   
                    btn.backgroundColor = [UIColor lightGrayColor];
                }else {
                    btn.backgroundColor = BlueColor;
                    btn.selected = YES;

                }
            }
            [btn setTitle:titl[i] forState:UIControlStateNormal];
            [btn setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
            btn.titleLabel.font = Font(13);
            btn.titleLabel.numberOfLines = 0;
            btn.titleLabel.textAlignment = NSTextAlignmentCenter;
            
            
            btn.layer.cornerRadius = 3;
            btn.tag = 10+i;
            lastBtn = btn;
            [view addSubview:btn];
        }
        
        
        SelectTimeView *dateview = [[SelectTimeView alloc]initWithFrame:CGRectMake(15, lastBtn.bottom+27, (view.width-30), 200)];
        dateview.backgroundColor = [UIColor clearColor];
        
        dateview.getSelectTimeStr = ^(NSString *time1,NSString *time2){
            NSLog(@"%@  %@",time1,time2);
            tmpstartTime = time1;
            tmpendTime = time2;
            
        };
        [view addSubview:dateview];
        
        
        {
            UIButton *btn = [[UIButton alloc]initWithFrame:CGRectMake(15,dateview.bottom, dateview.width, 45)];
            [btn addTarget:self action:@selector(sureShaixuan:) forControlEvents:UIControlEventTouchUpInside];
            btn.backgroundColor = BlueColor;
            [btn setTitle:@"确定" forState:UIControlStateNormal];
            [btn setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
            btn.titleLabel.font = Font(16);
            btn.layer.cornerRadius = 3;
            
            
            [view addSubview:btn];
            suresxBtn = btn;
        }
    }
    
}
-(void)sxbbtnClick:(UIButton *)btn{
    //    for (int i=0; i<4; i++) {
    //        UIButton *b = [btn.superview viewWithTag:10+i];
    //        b.backgroundColor = [UIColor lightGrayColor];
    //        
    //    }
    
    if ([btn.backgroundColor isEqual:BlueColor]) {
        btn.selected = NO;
        
        [btn setBackgroundColor:[UIColor lightGrayColor]];
    }else{
        btn.selected = YES;
        
        [btn setBackgroundColor:BlueColor];
    }
}
-(void)cancelAct{
    [UIView animateWithDuration:0.2 animations:^{
        shaixuanView.alpha = 0.0; 
    }];
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        shaixuanView.hidden = YES;
    });
}
-(void)sureShaixuan:(UIButton *)btrn{
    startTime = tmpstartTime;
    endTime = tmpendTime;
    
    for (int i=0; i<4; i++) {
        UIButton *btn = [btrn.superview viewWithTag:10+i];
        
        if (btn.selected) {
            switch (btn.tag) {
                case 10:
                    gt = YES;
                    break;
                case 11:
                    dc = YES;
                    break;
                case 12:
                    pt = YES;
                    break;
                case 13:
                    qt = YES;
                    break;
                    
                default:
                    break;
            }
            
            
            
        }else{
            switch (btn.tag) {
                case 10:
                    gt = NO;
                    break;
                case 11:
                    dc = NO;
                    break;
                case 12:
                    pt = NO;
                    break;
                case 13:
                    qt = NO;
                    break;
                    
                default:
                    break;
            }
            
            
        }
    }
    
    [UIView animateWithDuration:0.2 animations:^{
        shaixuanView.alpha = 0.0; 
    }];
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        shaixuanView.hidden = YES;
    });
    
    
    
    
    //开始本地筛选
    NSMutableArray *reslut = [NSMutableArray array];
    for (CheCiRes *res  in originalDataSource) {
        if (gt || dc || pt || qt) {
            if (gt) {
                if ([res.train_type isEqualToString:@"G"] || [res.train_type isEqualToString:@"C"] ) {
                    [reslut addObject:res];
                }
            }
            if (dc) {
                if ([res.train_type isEqualToString:@"D"]) {
                    [reslut addObject:res];
                }
            }
            if (pt) {
                if ([res.train_type isEqualToString:@"Z"] || [res.train_type isEqualToString:@"K"]  || [res.train_type isEqualToString:@"T"] ) {
                    [reslut addObject:res];
                }
            }
            if (qt) {
                if ([res.train_type isEqualToString:@"L"] || [res.train_type isEqualToString:@"Y"] ) {
                    [reslut addObject:res];
                }
            }
        }
    }
    
    
    
    NSInteger st111 = [self solveMinuteWithTime:startTime];
    NSInteger st222 = [self solveMinuteWithTime:endTime];
    
    NSMutableArray *result222 = [NSMutableArray array];
    
    for (CheCiRes *res  in reslut) {
        NSInteger tttm = [self solveMinuteWithTime:res.start_time];
        if (tttm>=st111 && tttm<=st222) {
            [result222 addObject:res];
            
        }
        
    }
    
    self.mainDataSource = result222;
    [self.mainTableView reloadData];
    
}
-(NSInteger)solveMinuteWithTime:(NSString *)str{
    if ([str componentsSeparatedByString:@":"].count) {
        
        NSInteger s21 =  [[str componentsSeparatedByString:@":"].firstObject integerValue];
        NSInteger s22 =  [[str componentsSeparatedByString:@":"].lastObject integerValue];
        NSInteger endminute = s21*60+s22;
        return endminute;
    }
    return 0;
    
}
- (void)setupDateView:(DateType)type {
    
    _pikerView = [HZQDatePickerView instanceDatePickerView];
    _pikerView.frame = CGRectMake(0, 0, SWIDTH, SHEIGHT + 20);
    [_pikerView setBackgroundColor:[UIColor clearColor]];
    _pikerView.delegate = self;
    _pikerView.type = type;
    // 今天开始往后的日期 
    [_pikerView.datePickerView setMinimumDate:[NSDate date]];
    //    NSDate *cur = [NSDate date];
    
    NSInteger oneDay = 24*60*60*1;  //1天的长度
    
    NSDate *theDate = [[NSDate date] initWithTimeIntervalSinceNow: +oneDay*30]; 
    // 在今天之前的日期
    [_pikerView.datePickerView setMaximumDate:theDate];
    [self.view addSubview:_pikerView];
    
}

- (void)getSelectDate:(NSString *)date type:(DateType)type {
    NSLog(@"%d - %@", type, date);
    
    train_date = date;
    
    NSDate *date2 = [AppManager dateFromString:train_date format:@"yyyy-MM-dd"] ;
    
    cur_chose_time = [date2 timeIntervalSince1970];
    
    [self loadNetData2];
}

- (IBAction)qiehuanClick:(UIButton *)sender {
    TrainStation *st = st1;
    st1 = st2;
    st2 = st;
    [self setStaionTtile];
}

-(void)setStaionTtile{
    _chufadi.text = st1.name;
    _mudidi.text = st2.name;
    [self loadNetData2];
    
}
@end
